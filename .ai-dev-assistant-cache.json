{
  "version": "1.0",
  "project_type": "React",
  "dependencies": {
    "npm": {
      "@neondatabase/serverless": "^0.9.0",
      "@vercel/analytics": "^1.6.1",
      "@vercel/postgres": "^0.10.0",
      "clsx": "^2.1.1",
      "lucide-react": "^0.554.0",
      "next": "16.0.10",
      "react": "19.2.0",
      "react-dom": "19.2.0",
      "react-hot-toast": "^2.6.0",
      "recharts": "^3.4.1",
      "tailwind-merge": "^3.4.0",
      "web-push": "^3.6.7",
      "@tailwindcss/postcss": "^4",
      "eslint": "^9",
      "eslint-config-next": "16.0.3",
      "tailwindcss": "^4"
    }
  },
  "files": {
    "jsconfig.json": {
      "path": "/Users/marcus.braun/repos/geckohub/jsconfig.json",
      "relative_path": "jsconfig.json",
      "size": 73,
      "extension": ".json",
      "is_code": true,
      "content": "{\n  \"compilerOptions\": {\n    \"paths\": {\n      \"@/*\": [\"./*\"]\n    }\n  }\n}\n",
      "content_hash": "21306b44064ae42bbbd715b1986abaf8",
      "lines": 8
    },
    "postcss.config.mjs": {
      "path": "/Users/marcus.braun/repos/geckohub/postcss.config.mjs",
      "relative_path": "postcss.config.mjs",
      "size": 94,
      "extension": ".mjs",
      "is_code": false,
      "content": null,
      "content_hash": null,
      "lines": 0
    },
    "next.config.mjs": {
      "path": "/Users/marcus.braun/repos/geckohub/next.config.mjs",
      "relative_path": "next.config.mjs",
      "size": 822,
      "extension": ".mjs",
      "is_code": false,
      "content": null,
      "content_hash": null,
      "lines": 0
    },
    "README.md": {
      "path": "/Users/marcus.braun/repos/geckohub/README.md",
      "relative_path": "README.md",
      "size": 1458,
      "extension": ".md",
      "is_code": true,
      "content": "This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).\n\n## Getting Started\n\nFirst, run the development server:\n\n```bash\nnpm run dev\n# or\nyarn dev\n# or\npnpm dev\n# or\nbun dev\n```\n\nOpen [http://localhost:3000](http://localhost:3000) with your browser to see the result.\n\nYou can start editing the page by modifying `app/page.js`. The page auto-updates as you edit the file.\n\nThis project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.\n\n## Learn More\n\nTo learn more about Next.js, take a look at the following resources:\n\n- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.\n- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.\n\nYou can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!\n\n## Deploy on Vercel\n\nThe easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.\n\nCheck out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.\n",
      "content_hash": "ff47271e53637b2ba6ba72ad2b70f6d7",
      "lines": 37
    },
    "package.json": {
      "path": "/Users/marcus.braun/repos/geckohub/package.json",
      "relative_path": "package.json",
      "size": 706,
      "extension": ".json",
      "is_code": true,
      "content": "{\n  \"name\": \"geckohub\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"eslint\"\n  },\n  \"dependencies\": {\n    \"@neondatabase/serverless\": \"^0.9.0\",\n    \"@vercel/analytics\": \"^1.6.1\",\n    \"@vercel/postgres\": \"^0.10.0\",\n    \"clsx\": \"^2.1.1\",\n    \"lucide-react\": \"^0.554.0\",\n    \"next\": \"16.0.10\",\n    \"react\": \"19.2.0\",\n    \"react-dom\": \"19.2.0\",\n    \"react-hot-toast\": \"^2.6.0\",\n    \"recharts\": \"^3.4.1\",\n    \"tailwind-merge\": \"^3.4.0\",\n    \"web-push\": \"^3.6.7\"\n  },\n  \"devDependencies\": {\n    \"@tailwindcss/postcss\": \"^4\",\n    \"eslint\": \"^9\",\n    \"eslint-config-next\": \"16.0.3\",\n    \"tailwindcss\": \"^4\"\n  }\n}\n",
      "content_hash": "4739e7a6a5cc70418fa6c245cffa9540",
      "lines": 32
    },
    ".env.example": {
      "path": "/Users/marcus.braun/repos/geckohub/.env.example",
      "relative_path": ".env.example",
      "size": 356,
      "extension": ".example",
      "is_code": false,
      "content": null,
      "content_hash": null,
      "lines": 0
    },
    "eslint.config.mjs": {
      "path": "/Users/marcus.braun/repos/geckohub/eslint.config.mjs",
      "relative_path": "eslint.config.mjs",
      "size": 400,
      "extension": ".mjs",
      "is_code": false,
      "content": null,
      "content_hash": null,
      "lines": 0
    },
    "app/layout.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/layout.js",
      "relative_path": "app/layout.js",
      "size": 3291,
      "extension": ".js",
      "is_code": true,
      "content": "import { Geist, Geist_Mono } from \"next/font/google\";\nimport \"./globals.css\";\nimport { Toaster } from 'react-hot-toast';\nimport { Analytics } from '@vercel/analytics/next';\nimport ServiceWorkerRegister from \"../components/ServiceWorkerRegister\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata = {\n  title: \"FlitzHQ - Smart Home Dashboard\",\n  description: \"Temperature, Humidity & Device Control\",\n  manifest: \"/manifest.json\",\n  appleWebApp: {\n    capable: true,\n    statusBarStyle: \"black-translucent\",\n    title: \"FlitzHQ\"\n  },\n  formatDetection: {\n    telephone: false\n  },\n  openGraph: {\n    type: \"website\",\n    siteName: \"FlitzHQ\",\n    title: \"FlitzHQ - Smart Home Dashboard\",\n    description: \"Temperature, Humidity & Device Control\"\n  },\n  icons: {\n    icon: [\n      { url: \"/icons/android-launchericon-192-192.png\", sizes: \"192x192\", type: \"image/png\", rel: \"icon\" },\n      { url: \"/icons/android-launchericon-512-512.png\", sizes: \"512x512\", type: \"image/png\", rel: \"icon\" },\n      { url: \"/icons/android-launchericon-192-192.png\", sizes: \"192x192\", type: \"image/png\", rel: \"icon\", purpose: \"maskable\" },\n      { url: \"/icons/android-launchericon-512-512.png\", sizes: \"512x512\", type: \"image/png\", rel: \"icon\", purpose: \"maskable\" }\n    ],\n    apple: [\n      { url: \"/apple-touch-icon.png\", sizes: \"180x180\", type: \"image/png\" }\n    ]\n  }\n};\n\nexport default function RootLayout({ children }) {\n  return (\n    <html lang=\"de\">\n      <head>\n        <meta\n          name=\"viewport\"\n          content=\"width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes\"\n        />\n        <meta name=\"theme-color\" content=\"#10b981\" />\n        <meta name=\"mobile-web-app-capable\" content=\"yes\" />\n        <link rel=\"manifest\" href=\"/manifest.json\" />\n        <link rel=\"apple-touch-icon\" href=\"/apple-touch-icon.png\" />\n        <link\n          rel=\"icon\"\n          type=\"image/png\"\n          sizes=\"192x192\"\n          href=\"/icons/android-launchericon-192-192.png\"\n        />\n        <link\n          rel=\"icon\"\n          type=\"image/png\"\n          sizes=\"512x512\"\n          href=\"/icons/android-launchericon-512-512.png\"\n        />\n      </head>\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n      >\n        <Toaster\n          position=\"top-right\"\n          toastOptions={{\n            duration: 4000,\n            style: {\n              background: '#1e293b',\n              color: '#e2e8f0',\n              border: '1px solid #475569',\n              padding: '16px',\n              borderRadius: '12px',\n              fontSize: '14px',\n              fontWeight: '500',\n              boxShadow: '0 10px 25px -5px rgb(0 0 0 / 0.5)'\n            },\n            success: {\n              iconTheme: {\n                primary: '#10b981',\n                secondary: '#1e293b',\n              },\n            },\n            error: {\n              iconTheme: {\n                primary: '#ef4444',\n                secondary: '#1e293b',\n              },\n            },\n          }}\n        />\n        <ServiceWorkerRegister />\n        {children}\n        <Analytics />\n      </body>\n    </html>\n  );\n}\n",
      "content_hash": "cd055dec8b1832fc619f6c09c27caa5f",
      "lines": 111
    },
    "app/page.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/page.js",
      "relative_path": "app/page.js",
      "size": 33949,
      "extension": ".js",
      "is_code": true,
      "content": "'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport Image from 'next/image';\nimport LoginScreen from '@/components/LoginScreen';\nimport toast from 'react-hot-toast';\nimport InstallPrompt from '@/components/InstallPrompt';\nimport EventsModal from '@/components/EventsModal';\nimport ThresholdScale from '@/components/ThresholdScale';\nimport SettingsModal from '@/components/SettingsModal';\nimport LightScheduleSettings from '@/components/LightScheduleSettings';\nimport NotificationSettings from '@/components/NotificationSettings';\nimport { evaluateTemperature, evaluateHumidity, TEMP_SCALE_CONFIG, HUMIDITY_SCALE_CONFIG } from '@/lib/gecko-thresholds';\nimport {\n  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine\n} from 'recharts';\nimport { \n  Thermometer, Droplets, Lightbulb, Flame, Activity, RefreshCw, Lock,\n  Calendar, Zap, Video, X, Settings\n} from 'lucide-react';\n\nexport default function Home() {\n  // --- STATE ---\n  const [currentData, setCurrentData] = useState({ temp: '--', hum: '--' });\n  const [shellyStatus, setShellyStatus] = useState({ light: false, heater: false });\n  const [historyData, setHistoryData] = useState([]);\n  const [deviceEvents, setDeviceEvents] = useState([]);\n\n  // UI States\n  const [timeRange, setTimeRange] = useState('24h');\n  const [loading, setLoading] = useState(true);\n  const [switching, setSwitching] = useState(null);\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\n  const [authChecked, setAuthChecked] = useState(false);\n  const [showEventsModal, setShowEventsModal] = useState(false);\n  const [showStreamModal, setShowStreamModal] = useState(false);\n  const [isSettingsOpen, setIsSettingsOpen] = useState(false);\n\n  // --- LOGIC ---\n  \n  const fetchHistory = useCallback(async () => {\n    try {\n      const res = await fetch(`/api/history?range=${timeRange}`);\n      const data = await res.json();\n      \n      if (Array.isArray(data) && data.length > 0) {\n          setHistoryData(data.map(d => ({\n              ...d,\n              // Fix f\u00fcr fehlende Linien: String -> Number Konvertierung\n              temp: d.temp ? parseFloat(d.temp) : null,\n              humidity: d.humidity ? parseFloat(d.humidity) : null,\n              displayTime: new Date(d.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })\n          })));\n          \n          // Fallback Live-Werte aus History\n          const last = data[data.length - 1];\n      if (last) setCurrentData({ temp: last.temp, hum: last.humidity });\n      }\n    } catch (e) { console.error(\"History Error\", e); }\n  }, [timeRange]);\n\n  // NEU: Lade Device Events f\u00fcr Chart-Visualisierung\n  const fetchEvents = useCallback(async () => {\n    const hoursMap = { '24h': 24, '7d': 168, '30d': 720 };\n    const hours = hoursMap[timeRange] || 24;\n\n    try {\n      const res = await fetch(`/api/events?hours=${hours}`);\n      \n      if (!res.ok) {\n        throw new Error(`Events API: ${res.status}`);\n      }\n      \n      const data = await res.json();\n      \n      if (data.events && Array.isArray(data.events)) {\n        setDeviceEvents(data.events);\n      }\n    } catch (e) {\n      console.error('[EVENTS ERROR]', e);\n      // Events sind optional - kein Toast bei Fehler\n      setDeviceEvents([]);\n    }\n  }, [timeRange]);\n\n  const fetchShellyStatus = useCallback(async () => {\n    try {\n      const res = await fetch('/api/status');\n      const data = await res.json();\n\n      if (data?.success && data.status) {\n        setShellyStatus(data.status);\n      }\n    } catch (error) {\n      console.error('Shelly Status Error', error);\n    }\n  }, []);\n\n  const fetchLive = useCallback(async () => {\n    // Govee\n    fetch('/api/sensor').then(r => r.json()).then(d => {\n        if(d?.data?.properties) {\n             const t = d.data.properties.find(p => p.temperature);\n             const h = d.data.properties.find(p => p.humidity);\n             if(t && h) setCurrentData({ temp: t.temperature, hum: h.humidity });\n        }\n    }).catch(() => {});\n\n    // Shelly Status\n    fetchShellyStatus();\n  }, [fetchShellyStatus]);\n\n  // Check Authentication beim Mount\n  useEffect(() => {\n    const localAuth = localStorage.getItem('flitzhq_auth');\n    const sessionAuth = sessionStorage.getItem('flitzhq_auth');\n\n    if (localAuth === 'true' || sessionAuth === 'true') {\n      setIsAuthenticated(true);\n    }\n\n    setAuthChecked(true);\n  }, []);\n\n  // Init & Loop\n  useEffect(() => {\n    if (!isAuthenticated) return;\n    setLoading(true);\n    Promise.all([fetchLive(), fetchHistory(), fetchEvents()]).finally(() => setLoading(false));\n    const interval = setInterval(() => { fetchLive(); fetchHistory(); fetchEvents(); }, 60000);\n    return () => clearInterval(interval);\n  }, [fetchLive, fetchHistory, fetchEvents, isAuthenticated]);\n\n  // Range Switch\n  useEffect(() => {\n    if (isAuthenticated) {\n      fetchHistory();\n      fetchEvents();\n    }\n  }, [timeRange, fetchHistory, fetchEvents, isAuthenticated]);\n\n  const toggleShelly = async (target) => {\n    setSwitching(target);\n    const oldState = shellyStatus[target];\n    setShellyStatus(prev => ({ ...prev, [target]: !oldState })); // Optimistic\n\n    try {\n      const newState = !oldState ? 'on' : 'off';\n      const res = await fetch('/api/shelly', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ target, action: newState })\n      });\n      const json = await res.json();\n      if(!json.success) throw new Error(json.error);\n      fetchShellyStatus();\n    } catch (e) {\n      setShellyStatus(prev => ({ ...prev, [target]: oldState }));\n      alert(\"Fehler beim Schalten!\");\n    } finally {\n      setSwitching(null);\n    }\n  };\n\n  // --- UI COMPONENTS ---\n  \n  const TimeRangeBtn = ({ r, label }) => (\n    <button\n      onClick={() => setTimeRange(r)}\n      className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${\n        timeRange === r\n          ? 'bg-emerald-500/20 text-emerald-400 shadow-lg shadow-emerald-500/20'\n          : 'text-slate-500 hover:text-slate-300 hover:bg-slate-700/40'\n      }`}\n    >\n      {label}\n    </button>\n  );\n\n  // NEU: Einfacher Event-Mapper (keine komplexe Period-Logic)\n  const getChartEvents = useCallback(() => {\n    if (!historyData.length || !deviceEvents.length) return [];\n\n    // Zeitbereich aus historyData (funktioniert mit ASC und DESC)\n    const timestamps = historyData.map(d => new Date(d.time).getTime());\n    const chartStart = Math.min(...timestamps);\n    const chartEnd = Math.max(...timestamps);\n\n    // Filtere Events im Chart-Zeitbereich\n    const filtered = deviceEvents\n      .filter(event => {\n        const eventTime = new Date(event.timestamp).getTime();\n        return eventTime >= chartStart && eventTime <= chartEnd;\n      })\n      .map(event => {\n        const eventDate = new Date(event.timestamp);\n        const eventTimeMs = eventDate.getTime();\n\n        // Snap Event auf den n\u00e4chsten History-Datenpunkt, damit ReferenceLine-X exakt matcht\n        const closestDataPoint = historyData.reduce((closest, dataPoint) => {\n          const dataTime = new Date(dataPoint.time).getTime();\n          const closestTime = new Date(closest.time).getTime();\n          const currentDiff = Math.abs(dataTime - eventTimeMs);\n          const closestDiff = Math.abs(closestTime - eventTimeMs);\n          return currentDiff < closestDiff ? dataPoint : closest;\n        }, historyData[0]);\n\n        return {\n          timestamp: eventTimeMs,\n          displayTime: closestDataPoint.displayTime,\n          device: event.device,\n          action: event.action,\n          source: event.source\n        };\n      });\n\n    if (filtered.length > 0) {\n      console.log('[CHART EVENTS] mapped', {\n        count: filtered.length,\n        sample: filtered[0],\n        historySample: historyData.slice(0, 3).map(d => d.displayTime)\n      });\n    }\n\n    return filtered;\n  }, [historyData, deviceEvents]);\n\n  const chartEvents = getChartEvents();\n\n  if (!authChecked) {\n    return (\n      <div className=\"min-h-screen bg-slate-950 flex items-center justify-center\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <div className=\"w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30 animate-pulse\">\n            <Activity size={32} />\n          </div>\n          <p className=\"text-slate-500 text-sm\">Lade FlitzHQ...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return <LoginScreen onLoginSuccess={() => setIsAuthenticated(true)} />;\n  }\n\n  return (\n    <>\n      <InstallPrompt />\n      {/* Background Layer */}\n      <div className=\"fixed inset-0 -z-10\">\n        <Image\n          src=\"/images/background.jpg\"\n          alt=\"\"\n          fill\n          className=\"object-cover opacity-15\"\n          priority\n          quality={90}\n        />\n        <div className=\"absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900/80 to-slate-950\" />\n      </div>\n\n      <div className=\"min-h-screen bg-slate-950 text-slate-100 font-sans pb-10 selection:bg-emerald-400/30\">\n\n        {/* Header */}\n          <header className=\"bg-slate-900/90 backdrop-blur-xl border-b border-slate-700/50 sticky top-0 z-20 shadow-2xl shadow-black/20\">\n            <div className=\"max-w-6xl mx-auto px-6 h-20 flex items-center justify-between\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"w-10 h-10 bg-gradient-to-br from-emerald-500 via-teal-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-800/40 ring-1 ring-white/20\">\n                  <Activity size={22} className=\"text-white\" />\n                </div>\n                <div>\n                  <h1 className=\"font-bold text-xl tracking-tight text-slate-100\">Flitz<span className=\"text-emerald-400\">HQ</span></h1>\n                  <p className=\"text-[11px] text-slate-500 font-semibold tracking-[0.25em] uppercase\">Sir Flitzalot Automation</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <button\n                  onClick={() => {\n                    localStorage.removeItem('flitzhq_auth');\n                    sessionStorage.removeItem('flitzhq_auth');\n                    setIsAuthenticated(false);\n                    toast('Abgemeldet', { icon: '\ud83d\udc4b' });\n                  }}\n                  className=\"p-2 bg-slate-800/60 backdrop-blur-sm rounded-full hover:bg-slate-700/80 text-slate-400 hover:text-slate-300 transition-colors\"\n                  title=\"Abmelden\"\n                >\n                  <Lock size={18} />\n                </button>\n                <button\n                  onClick={() => setShowStreamModal(true)}\n                  className=\"p-2 bg-slate-800/60 backdrop-blur-sm rounded-full border border-slate-700/50 hover:border-emerald-500/50 hover:bg-emerald-500/10 transition-all text-slate-300 hover:text-emerald-300\"\n                  title=\"Live-Stream\"\n                >\n                  <Video size={18} />\n                </button>\n                <div className=\"flex items-center gap-2\">\n                  <button\n                    onClick={() => {\n                      fetchLive();\n                      fetchHistory();\n                      fetchEvents();\n                      toast('Aktualisiere Daten...', { icon: '\ud83d\udd04' });\n                    }}\n                    className={`p-2 bg-slate-800/60 backdrop-blur-sm rounded-full border border-slate-700/50 hover:border-slate-600 hover:bg-slate-700/80 transition-all text-slate-300 hover:text-slate-100 ${loading ? 'animate-spin text-emerald-400' : ''}`}\n                    title=\"Daten aktualisieren\"\n                  >\n                    <RefreshCw size={18} />\n                  </button>\n                  <button\n                    onClick={() => setIsSettingsOpen(true)}\n                    className=\"p-2 bg-slate-800/60 backdrop-blur-sm rounded-full border border-slate-700/50 hover:border-slate-600 hover:bg-slate-700/80 transition-all text-slate-300 hover:text-slate-100\"\n                    title=\"Einstellungen\"\n                  >\n                    <Settings size={18} />\n                  </button>\n                </div>\n              </div>\n            </div>\n          </header>\n\n        <main className=\"max-w-6xl mx-auto px-6 py-10 space-y-8\">\n\n        {/* --- CARDS --- */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n\n            {/* Temperatur Card */}\n              <div className=\"relative bg-slate-900/70 backdrop-blur-md rounded-2xl p-6 shadow-2xl shadow-black/20 border border-slate-700/30 overflow-hidden group transition-all duration-500\">\n                 <div className=\"absolute -right-10 -top-16 w-40 h-40 bg-gradient-to-br from-orange-500/20 via-amber-400/10 to-rose-500/15 rounded-full blur-3xl opacity-80 group-hover:opacity-100 transition-all\" />\n                 <div className=\"absolute -left-6 bottom-[-60px] w-40 h-40 bg-gradient-to-tr from-emerald-500/10 to-teal-400/5 rounded-full blur-3xl\" />\n                 <div className=\"absolute inset-x-0 bottom-0 h-px bg-gradient-to-r from-transparent via-white/40 to-transparent\" />\n                 <div className=\"relative z-10\">\n                   <div className=\"flex justify-between items-start mb-2\">\n                      <p className=\"text-slate-500 text-xs font-bold uppercase tracking-widest\">Temperatur</p>\n                      <Thermometer size={24} className=\"text-amber-300 group-hover:text-orange-300 transition-colors\"/>\n                   </div>\n                    {(() => {\n                      const tempValue = Number(currentData.temp);\n                      const hasTemp = Number.isFinite(tempValue);\n                      const tempStatus = hasTemp ? evaluateTemperature(tempValue) : null;\n                      const tempScaleValue = hasTemp ? tempValue : TEMP_SCALE_CONFIG.min;\n\n                      return (\n                        <div className=\"space-y-4\">\n                          <div className=\"flex items-center justify-between gap-4\">\n                            <div className=\"flex items-baseline gap-2\">\n                              <span className=\"text-5xl font-extrabold text-slate-100 tracking-tighter drop-shadow-[0_8px_25px_rgba(0,0,0,0.45)]\">{currentData.temp}</span>\n                              <span className=\"text-xl text-slate-500 ml-1\">\u00b0C</span>\n                            </div>\n                            {tempStatus && (\n                              <div\n                                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border border-current ${tempStatus.bgColor} ${tempStatus.textColor} ${tempStatus.status === 'critical' ? 'animate-pulse-critical' : ''}`}\n                              >\n                                <span className=\"text-lg\">{tempStatus.icon}</span>\n                                <span className=\"text-xs font-semibold tracking-wide\">{tempStatus.label}</span>\n                              </div>\n                            )}\n                          </div>\n                          <ThresholdScale\n                            value={tempScaleValue}\n                            min={TEMP_SCALE_CONFIG.min}\n                            max={TEMP_SCALE_CONFIG.max}\n                            thresholds={TEMP_SCALE_CONFIG.thresholds}\n                            type=\"temperature\"\n                          />\n                        </div>\n                      );\n                    })()}\n               </div>\n            </div>\n            {/* Humidity Card */}\n              <div className=\"relative bg-slate-900/70 backdrop-blur-md rounded-2xl p-6 shadow-2xl shadow-black/20 border border-slate-700/30 overflow-hidden group transition-all duration-500\">\n                 {/* Background Icon */}\n                 <div className=\"absolute top-0 right-0 p-4 opacity-10 text-slate-700\">\n                   <Droplets size={120} />\n                 </div>\n\n                 {/* Animierte Tropfen bei >70% */}\n                 {currentData.hum > 70 && (\n                   <div className=\"absolute inset-0 pointer-events-none\">\n                     {[...Array(6)].map((_, i) => (\n                       <div\n                         key={i}\n                         className=\"droplet absolute text-blue-400/30\"\n                         style={{\n                           left: `${Math.random() * 80 + 10}%`,\n                           animationDelay: `${i * 0.5}s`,\n                           animationDuration: `${3 + Math.random() * 2}s`\n                         }}\n                       >\n                         <Droplets size={16} />\n                       </div>\n                     ))}\n                   </div>\n                 )}\n\n                 <div className=\"relative z-10\">\n                    <div className=\"flex justify-between items-start mb-2\">\n                       <p className=\"text-slate-500 text-xs font-bold uppercase tracking-widest\">Feuchtigkeit</p>\n                       <Droplets size={24} className=\"text-sky-200 group-hover:text-cyan-200 transition-colors\"/>\n                    </div>\n                    {(() => {\n                      const humidityValue = Number(currentData.hum);\n                      const hasHumidity = Number.isFinite(humidityValue);\n                      const humidityStatus = hasHumidity ? evaluateHumidity(humidityValue) : null;\n                      const humidityScaleValue = hasHumidity ? humidityValue : HUMIDITY_SCALE_CONFIG.min;\n\n                      return (\n                        <div className=\"space-y-4\">\n                          <div className=\"flex items-center justify-between gap-4 mt-1\">\n                            <div className=\"flex items-baseline gap-2\">\n                              <span className=\"text-5xl font-extrabold text-slate-100\">{currentData.hum}</span>\n                              <span className=\"text-xl text-slate-500 ml-1\">%</span>\n                            </div>\n                            {humidityStatus && (\n                              <div\n                                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border border-current ${humidityStatus.bgColor} ${humidityStatus.textColor} ${humidityStatus.status === 'critical' ? 'animate-pulse-critical' : ''}`}\n                              >\n                                <span className=\"text-lg\">{humidityStatus.icon}</span>\n                                <span className=\"text-xs font-semibold tracking-wide\">{humidityStatus.label}</span>\n                              </div>\n                            )}\n                          </div>\n                          <ThresholdScale\n                            value={humidityScaleValue}\n                            min={HUMIDITY_SCALE_CONFIG.min}\n                            max={HUMIDITY_SCALE_CONFIG.max}\n                            thresholds={HUMIDITY_SCALE_CONFIG.thresholds}\n                            type=\"humidity\"\n                          />\n                        </div>\n                      );\n                    })()}\n                 </div>\n              </div>\n              {/* Control Panel */}\n              <div className=\"bg-slate-900/70 backdrop-blur-md rounded-2xl p-6 shadow-2xl shadow-black/20 border border-slate-700/30 flex flex-col justify-center gap-4\">\n                <p className=\"text-slate-500 text-xs font-bold uppercase tracking-widest mb-1 px-2\">Smart Controls</p>\n\n              {/* Licht Button */}\n              <button\n                 onClick={() => toggleShelly('light')}\n                 disabled={switching === 'light'}\n                  className={`relative group w-full flex items-center justify-between p-4 rounded-2xl border transition-all duration-300 overflow-hidden\n                    ${shellyStatus.light\n                      ? 'border-yellow-500 bg-yellow-900/30 shadow-lg shadow-yellow-500/20'\n                      : 'border-slate-700/60 hover:border-slate-600 bg-slate-800/40'}`}\n                >\n                  <div className={`absolute inset-0 bg-yellow-500/15 blur-3xl transition-opacity duration-500 ${shellyStatus.light ? 'opacity-100' : 'opacity-0'}`}></div>\n                  <div className=\"relative flex items-center gap-4\">\n                      <div className={`p-2 rounded-full ${shellyStatus.light ? 'bg-yellow-500 text-white shadow-lg shadow-yellow-500/50' : 'bg-slate-700 text-slate-500'}`}>\n                          <Lightbulb size={20}/>\n                      </div>\n                      <div className=\"text-left\">\n                          <div className=\"font-bold text-sm text-slate-200\">Tageslicht</div>\n                          <div className=\"text-[10px] text-slate-500 uppercase font-bold\">{shellyStatus.light ? 'AN' : 'AUS'}</div>\n                      </div>\n                  </div>\n                  {switching === 'light' && <RefreshCw size={16} className=\"animate-spin text-slate-200\"/>}\n               </button>\n\n              {/* Heizung Button */}\n              <button\n                 onClick={() => toggleShelly('heater')}\n                 disabled={switching === 'heater'}\n                  className={`relative group w-full flex items-center justify-between p-4 rounded-2xl border transition-all duration-300 ease-in-out overflow-hidden\n                    ${shellyStatus.heater\n                      ? 'border-orange-500 bg-orange-900/30 shadow-lg shadow-orange-500/20'\n                      : 'border-slate-700/60 hover:border-slate-600 bg-slate-800/40'}`}\n                >\n                  <div className={`absolute inset-0 bg-gradient-to-br from-orange-400/20 via-amber-500/10 to-red-500/20 blur-3xl transition-opacity duration-500 ${shellyStatus.heater ? 'opacity-100' : 'opacity-0'}`}></div>\n                  <div className=\"relative flex items-center gap-4\">\n                      <div className={`p-2 rounded-full ${shellyStatus.heater ? 'bg-gradient-to-br from-orange-500 to-red-500 text-white shadow-lg shadow-orange-500/50' : 'bg-slate-700 text-slate-500'}`}>\n                          <Flame size={20}/>\n                      </div>\n                      <div className=\"text-left\">\n                          <div className=\"font-bold text-sm text-slate-200\">Heizung</div>\n                          <div className=\"text-[10px] text-slate-500 uppercase font-bold\">{shellyStatus.heater ? 'AN' : 'AUS'}</div>\n                      </div>\n                  </div>\n                  {switching === 'heater' && <RefreshCw size={16} className=\"animate-spin text-slate-200\"/>}\n               </button>\n          </div>\n\n        </div>\n          {/* --- CHART SECTION --- */}\n            <div className=\"bg-slate-900/70 backdrop-blur-md rounded-2xl p-6 shadow-2xl shadow-black/20 border border-slate-700/30\">\n              <div className=\"flex flex-col md:flex-row justify-between items-center mb-8 gap-6\">\n                <div className=\"flex items-center gap-3\">\n                   <h3 className=\"font-bold text-slate-200 flex items-center gap-2\">\n                     <Calendar size={18} className=\"text-emerald-400\"/> Verlauf\n                   </h3>\n                </div>\n                <div className=\"flex bg-slate-800/60 backdrop-blur-sm p-1 rounded-lg\">\n                    <TimeRangeBtn r=\"24h\" label=\"24 Std\" />\n                    <TimeRangeBtn r=\"7d\" label=\"7 Tage\" />\n                    <TimeRangeBtn r=\"30d\" label=\"30 Tage\" />\n            </div>\n          </div>\n          \n          <div className=\"h-80 w-full\">\n            {historyData.length > 0 ? (\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <LineChart data={historyData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f1f5f9\" />\n                    <XAxis dataKey=\"displayTime\" tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} interval=\"preserveStartEnd\" minTickGap={30}/>\n                    <YAxis yAxisId=\"left\" domain={['auto', 'auto']} tick={{fontSize: 11, fill: '#ef4444'}} axisLine={false} tickLine={false} />\n                    <YAxis yAxisId=\"right\" orientation=\"right\" domain={[0, 100]} tick={{fontSize: 11, fill: '#3b82f6'}} axisLine={false} tickLine={false} />\n                    <Tooltip\n                        contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 4px 12px -2px rgb(0 0 0 / 0.1)'}}\n                        labelStyle={{color: '#94a3b8', fontSize: '12px', marginBottom: '4px'}}\n                    />\n\n                    {/* Device Events als vertikale Linien */}\n                    {chartEvents.map((event, idx) => {\n                      const isLight = event.device === 'light';\n                      const isOn = event.action === 'on';\n\n                      // Farben: Gelb f\u00fcr Light, Orange f\u00fcr Heater\n                      const color = isLight ? '#eab308' : '#f97316';\n\n                      // Stil: Durchgezogen f\u00fcr ON, Gestrichelt f\u00fcr OFF\n                      const strokeDasharray = isOn ? '0' : '4 4';\n\n                      // Label: L/H f\u00fcr Device, \u2191/\u2193 f\u00fcr ON/OFF\n                      const deviceLabel = isLight ? 'L' : 'H';\n                      const actionLabel = isOn ? '\u2191' : '\u2193';\n                      const labelText = `${deviceLabel}${actionLabel}`;\n\n                      // Label Position: ON oben, OFF unten (weniger Overlap)\n                      const labelPosition = isOn ? 'top' : 'bottom';\n\n                      return (\n                        <ReferenceLine\n                          key={`event-${idx}-${event.timestamp}`}\n                          x={event.displayTime}\n                          yAxisId=\"left\"\n                          stroke={color}\n                          strokeWidth={2}\n                          strokeDasharray={strokeDasharray}\n                          strokeOpacity={0.6}\n                          label={{\n                            value: labelText,\n                            position: labelPosition,\n                            fontSize: 12,\n                            fontWeight: 'bold',\n                            fill: color,\n                            offset: 10\n                          }}\n                        />\n                      );\n                    })}\n\n                    <Line yAxisId=\"left\" type=\"monotone\" dataKey=\"temp\" stroke=\"#ef4444\" strokeWidth={3} dot={false} activeDot={{r: 6}} name=\"Temp\" unit=\"\u00b0C\" />\n                    <Line yAxisId=\"right\" type=\"monotone\" dataKey=\"humidity\" stroke=\"#3b82f6\" strokeWidth={3} dot={false} activeDot={{r: 6}} name=\"Feuchte\" unit=\"%\" />\n                  </LineChart>\n                </ResponsiveContainer>\n            ) : (\n                <div className=\"h-full flex flex-col items-center justify-center text-slate-600\">\n                    <Activity size={48} className=\"mb-2 opacity-20\" />\n                    <p className=\"text-slate-500\">Sammle Daten... (Warte auf ersten Cron-Job)</p>\n                    <p className=\"text-xs mt-2 opacity-60 text-slate-600\">Tipp: Rufe /api/cron einmal manuell auf</p>\n                </div>\n              )}\n              \n              {/* NEU: Event Legend */}\n              {chartEvents.length > 0 && (\n                <div className=\"mt-4 pt-4 border-t border-slate-700/30\">\n                  <div className=\"flex flex-wrap items-center gap-4 text-xs\">\n                    <span className=\"text-slate-500 font-bold uppercase tracking-wider\">Events:</span>\n                    \n                    {/* Light Legend */}\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex items-center gap-1\">\n                        <div className=\"w-8 h-0.5 bg-yellow-500/60\" />\n                        <span className=\"text-yellow-500 font-bold\">L\u2191</span>\n                      </div>\n                      <span className=\"text-slate-400\">Licht AN</span>\n                    </div>\n                    \n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex items-center gap-1\">\n                        <div className=\"w-8 h-0.5 bg-yellow-500/60 border-t-2 border-dashed border-yellow-500/60\" />\n                        <span className=\"text-yellow-500 font-bold\">L\u2193</span>\n                      </div>\n                      <span className=\"text-slate-400\">Licht AUS</span>\n                    </div>\n                    \n                    {/* Heater Legend */}\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex items-center gap-1\">\n                        <div className=\"w-8 h-0.5 bg-orange-500/60\" />\n                        <span className=\"text-orange-500 font-bold\">H\u2191</span>\n                      </div>\n                      <span className=\"text-slate-400\">Heizung AN</span>\n                    </div>\n                    \n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex items-center gap-1\">\n                        <div className=\"w-8 h-0.5 bg-orange-500/60 border-t-2 border-dashed border-orange-500/60\" />\n                        <span className=\"text-orange-500 font-bold\">H\u2193</span>\n                      </div>\n                      <span className=\"text-slate-400\">Heizung AUS</span>\n                    </div>\n                    \n                    {/* Event Count - Klickbar */}\n                    <button\n                      onClick={() => setShowEventsModal(true)}\n                      className=\"text-slate-600 hover:text-emerald-400 ml-auto transition-colors cursor-pointer font-medium hover:underline underline-offset-2\"\n                    >\n                      {chartEvents.length} {chartEvents.length === 1 ? 'Event' : 'Events'}\n                    </button>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Events Modal */}\n          <EventsModal\n            isOpen={showEventsModal}\n            onClose={() => setShowEventsModal(false)}\n            events={deviceEvents}\n          />\n\n          {showStreamModal && (\n            <>\n              <div\n                className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-40\"\n                onClick={() => setShowStreamModal(false)}\n              />\n              <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none\">\n                <div\n                  className=\"bg-slate-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 w-full max-w-4xl pointer-events-auto\"\n                  onClick={(e) => e.stopPropagation()}\n                >\n                  <div className=\"flex items-center justify-between p-6 border-b border-slate-700/50\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 bg-emerald-500/20 rounded-lg\">\n                        <Video size={22} className=\"text-emerald-400\" />\n                      </div>\n                      <div>\n                        <h2 className=\"text-xl font-bold text-slate-100\">Live-Stream</h2>\n                        <p className=\"text-sm text-slate-400\">Video-Stream in Vorbereitung</p>\n                      </div>\n                    </div>\n                    <button\n                      onClick={() => setShowStreamModal(false)}\n                      className=\"p-2 hover:bg-white/10 rounded-lg transition-colors\"\n                      aria-label=\"Schlie\u00dfen\"\n                    >\n                      <X size={20} className=\"text-slate-400\" />\n                    </button>\n                  </div>\n\n                  <div className=\"p-6\">\n                    <div className=\"aspect-video w-full rounded-xl border border-dashed border-emerald-500/50 bg-gradient-to-br from-slate-800 via-slate-900 to-slate-950 flex items-center justify-center relative overflow-hidden\">\n                      <div className=\"absolute inset-0 opacity-40 bg-[radial-gradient(circle_at_20%_20%,rgba(34,197,94,0.25),transparent_35%),radial-gradient(circle_at_80%_0%,rgba(52,211,153,0.15),transparent_25%),radial-gradient(circle_at_50%_80%,rgba(59,130,246,0.15),transparent_30%)]\" />\n                      <div className=\"relative z-10 text-center space-y-3 px-6\">\n                        <div className=\"inline-flex items-center justify-center p-3 rounded-full bg-emerald-500/10 border border-emerald-400/40\">\n                          <Video size={28} className=\"text-emerald-300\" />\n                        </div>\n                        <div>\n                          <p className=\"text-lg font-semibold text-slate-100\">Live-Stream demn\u00e4chst verf\u00fcgbar</p>\n                          <p className=\"text-sm text-slate-400 mt-1\">\n                            Hier erscheint der Video-Feed, sobald die Kamera angebunden ist. Bleib gespannt!\n                          </p>\n                        </div>\n                        <div className=\"flex items-center justify-center gap-2 text-xs text-emerald-300\">\n                          <span className=\"w-2 h-2 rounded-full bg-emerald-400 animate-pulse\" />\n                          <span>Placeholder aktiv</span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </>\n          )}\n\n          {/* Settings Modal */}\n          <SettingsModal\n            isOpen={isSettingsOpen}\n            onClose={() => setIsSettingsOpen(false)}\n            tabs={[\n              {\n                label: 'Automationen',\n                content: <LightScheduleSettings />\n              },\n              {\n                label: 'Benachrichtigungen',\n                content: <NotificationSettings />\n              }\n            ]}\n          />\n\n          </main>\n        </div>\n      </>\n    );\n}\n",
      "content_hash": "e9e51669ccf88f2c937b4abdef968096",
      "lines": 702
    },
    "app/globals.css": {
      "path": "/Users/marcus.braun/repos/geckohub/app/globals.css",
      "relative_path": "app/globals.css",
      "size": 2179,
      "extension": ".css",
      "is_code": true,
      "content": "@import \"tailwindcss\";\n\n\n:root {\n  --background: #05070f;\n  --foreground: #e2e8f0;\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --font-sans: var(--font-geist-sans);\n  --font-mono: var(--font-geist-mono);\n}\n\n@media (prefers-color-scheme: dark) {\n  :root {\n    --background: #0a0a0a;\n    --foreground: #ededed;\n  }\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: Arial, Helvetica, sans-serif;\n}\n\n@keyframes droplet-fall {\n  0% {\n    transform: translateY(-20px) scale(0);\n    opacity: 0;\n  }\n  10% {\n    opacity: 1;\n  }\n  90% {\n    opacity: 1;\n  }\n  100% {\n    transform: translateY(400px) scale(1);\n    opacity: 0;\n  }\n}\n\n.droplet {\n  animation: droplet-fall 3s ease-in infinite;\n}\n\n.droplet:nth-child(2) { animation-delay: 0.5s; }\n.droplet:nth-child(3) { animation-delay: 1s; }\n.droplet:nth-child(4) { animation-delay: 1.5s; }\n.droplet:nth-child(5) { animation-delay: 2s; }\n.droplet:nth-child(6) { animation-delay: 2.5s; }\n\n@keyframes drop-fall {\n  0% { transform: translateY(0) scale(1); }\n  10% { transform: translateY(2px) scale(1.05) skewX(1deg); }\n  25% { transform: translateY(15px) scale(0.95) skewX(-1deg); }\n  40% { transform: translateY(50px) scale(1.02) skewX(1deg); }\n  100% { transform: translateY(450px) scale(0.9); opacity: 0; }\n}\n\n.animate-drop-fall {\n  animation: drop-fall cubic-bezier(0.45, 0, 0.55, 1) infinite;\n}\n\n/* Custom Scrollbar f\u00fcr Modal */\n.scrollbar-thin::-webkit-scrollbar {\n  width: 8px;\n}\n\n.scrollbar-thin::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.scrollbar-thin::-webkit-scrollbar-thumb {\n  background-color: rgb(71 85 105 / 0.8);\n  border-radius: 4px;\n}\n\n.scrollbar-thin::-webkit-scrollbar-thumb:hover {\n  background-color: rgb(100 116 139);\n}\n\n.scrollbar-track-slate-800\\/50::-webkit-scrollbar-track {\n  background-color: rgb(30 41 59 / 0.5);\n}\n\n.scrollbar-thumb-slate-600::-webkit-scrollbar-thumb {\n  background-color: rgb(71 85 105);\n}\n\n@keyframes pulse-critical {\n  0%, 100% {\n    opacity: 1;\n  }\n  50% {\n    opacity: 0.7;\n  }\n}\n\n.animate-pulse-critical {\n  animation: pulse-critical 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;\n}\n",
      "content_hash": "713d829777be17b1431287bbc2b9a2a7",
      "lines": 106
    },
    "app/api/cache-stats/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/cache-stats/route.js",
      "relative_path": "app/api/cache-stats/route.js",
      "size": 656,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\n\n// Import cache variables (in production w\u00fcrde man Redis verwenden)\n// F\u00fcr Development: Cache Stats Endpoint\n\nexport async function GET() {\n  // Dieser Endpoint zeigt Cache-Statistiken an\n  // N\u00fctzlich f\u00fcr Debugging und Monitoring\n  \n  return NextResponse.json({\n    message: 'Cache Stats Endpoint',\n    info: 'In Memory Caching aktiv. Stats werden in Console geloggt.',\n    recommendation: 'F\u00fcr Production: Redis oder Vercel KV nutzen',\n    caching: {\n      sensor: '30s Cache-Duration',\n      shelly: '5s Cache-Duration',\n      history: '2min Cache-Duration',\n      cron: '1min Rate Limit'\n    }\n  });\n}\n",
      "content_hash": "14f420b34417ea4c1f5e69d71f2a4961",
      "lines": 22
    },
    "app/api/notification-settings/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/notification-settings/route.js",
      "relative_path": "app/api/notification-settings/route.js",
      "size": 2378,
      "extension": ".js",
      "is_code": true,
      "content": "import { sql } from '@vercel/postgres';\nimport { NextResponse } from 'next/server';\n\nexport async function GET() {\n  try {\n    const result = await sql`\n      SELECT * FROM notification_settings\n      ORDER BY id DESC\n      LIMIT 1\n    `;\n\n    const settings = result.rows[0] || {\n      push_enabled: false,\n      email_enabled: false,\n      temp_critical_low: 18,\n      temp_critical_high: 30,\n      humidity_critical_low: 40,\n      humidity_critical_high: 90,\n      notification_cooldown_minutes: 60\n    };\n\n    return NextResponse.json(settings);\n  } catch (error) {\n    console.error('Error fetching settings:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch settings' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request) {\n  try {\n    const settings = await request.json();\n\n    await sql`\n      INSERT INTO notification_settings (\n        id,\n        push_enabled,\n        email_enabled,\n        email_address,\n        temp_critical_low,\n        temp_critical_high,\n        humidity_critical_low,\n        humidity_critical_high,\n        notification_cooldown_minutes,\n        updated_at\n      )\n      VALUES (\n        1,\n        ${settings.push_enabled},\n        ${settings.email_enabled},\n        ${settings.email_address || null},\n        ${settings.temp_critical_low},\n        ${settings.temp_critical_high},\n        ${settings.humidity_critical_low},\n        ${settings.humidity_critical_high},\n        ${settings.notification_cooldown_minutes},\n        NOW()\n      )\n      ON CONFLICT (id)\n      DO UPDATE SET\n        push_enabled = ${settings.push_enabled},\n        email_enabled = ${settings.email_enabled},\n        email_address = ${settings.email_address || null},\n        temp_critical_low = ${settings.temp_critical_low},\n        temp_critical_high = ${settings.temp_critical_high},\n        humidity_critical_low = ${settings.humidity_critical_low},\n        humidity_critical_high = ${settings.humidity_critical_high},\n        notification_cooldown_minutes = ${settings.notification_cooldown_minutes},\n        updated_at = NOW()\n    `;\n\n    return NextResponse.json({\n      success: true,\n      message: 'Settings updated'\n    });\n  } catch (error) {\n    console.error('Error updating settings:', error);\n    return NextResponse.json(\n      { error: 'Failed to update settings' },\n      { status: 500 }\n    );\n  }\n}\n",
      "content_hash": "7c8e328340d0a21afae12819c2946267",
      "lines": 86
    },
    "app/api/auth/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/auth/route.js",
      "relative_path": "app/api/auth/route.js",
      "size": 930,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\n\nexport async function POST(request) {\n  try {\n    const { password } = await request.json();\n\n    const correctPassword = process.env.USER_PASSWORD;\n\n    if (!correctPassword) {\n      return NextResponse.json(\n        {\n          error: 'Server-Konfigurationsfehler',\n          details: 'USER_PASSWORD nicht gesetzt',\n        },\n        { status: 500 },\n      );\n    }\n\n    if (password === correctPassword) {\n      return NextResponse.json({\n        success: true,\n        message: 'Login erfolgreich',\n      });\n    }\n\n    return NextResponse.json(\n      {\n        success: false,\n        message: 'Falsches Passwort',\n      },\n      { status: 401 },\n    );\n  } catch (error) {\n    console.error('[AUTH ERROR]', error);\n    return NextResponse.json(\n      {\n        error: 'Authentication fehlgeschlagen',\n        details: error.message,\n      },\n      { status: 500 },\n    );\n  }\n}\n",
      "content_hash": "395c90be9cdc0012344aef1d4348419d",
      "lines": 44
    },
    "app/api/setup/push-notifications/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/setup/push-notifications/route.js",
      "relative_path": "app/api/setup/push-notifications/route.js",
      "size": 10586,
      "extension": ".js",
      "is_code": true,
      "content": "import { sql } from '@vercel/postgres';\nimport { NextResponse } from 'next/server';\n\n// Dynamisches Import von web-push (ESM Kompatibilit\u00e4t)\nconst webPush = require('web-push');\n\nexport async function GET(request) {\n  // Security: Nur ausf\u00fchrbar wenn noch keine Keys gesetzt\n  if (process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY && process.env.VAPID_PRIVATE_KEY) {\n    return new Response(\n      `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <title>Push Setup bereits abgeschlossen</title>\n        <style>\n          body {\n            font-family: system-ui, -apple-system, sans-serif;\n            max-width: 800px;\n            margin: 50px auto;\n            padding: 20px;\n            background: #0f172a;\n            color: #e2e8f0;\n          }\n          .container {\n            background: #1e293b;\n            border-radius: 12px;\n            padding: 30px;\n            border: 1px solid #334155;\n          }\n          h1 { color: #10b981; }\n          .success { color: #10b981; }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <h1>\u2705 Setup bereits abgeschlossen</h1>\n          <p class=\"success\">VAPID Keys sind bereits in Vercel Environment Variables gesetzt.</p>\n          <p>Falls du neue Keys generieren m\u00f6chtest, l\u00f6sche erst die bestehenden ENV Vars in Vercel.</p>\n          <br>\n          <a href=\"/\" style=\"color: #10b981;\">\u2190 Zur\u00fcck zum Dashboard</a>\n        </div>\n      </body>\n      </html>\n      `,\n      {\n        headers: { 'Content-Type': 'text/html' },\n      }\n    );\n  }\n\n  try {\n    // STEP 1: VAPID Keys generieren\n    const vapidKeys = webPush.generateVAPIDKeys();\n\n    // STEP 2: Datenbank-Tabellen erstellen\n    let dbStatus = {\n      push_subscriptions: false,\n      notification_settings: false,\n      initial_settings: false\n    };\n\n    try {\n      // push_subscriptions Tabelle\n      await sql`\n        CREATE TABLE IF NOT EXISTS push_subscriptions (\n          id SERIAL PRIMARY KEY,\n          endpoint TEXT UNIQUE NOT NULL,\n          keys JSONB NOT NULL,\n          user_agent TEXT,\n          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n          last_notification_at TIMESTAMP\n        )\n      `;\n      dbStatus.push_subscriptions = true;\n\n      // notification_settings Tabelle\n      await sql`\n        CREATE TABLE IF NOT EXISTS notification_settings (\n          id SERIAL PRIMARY KEY,\n          push_enabled BOOLEAN DEFAULT false,\n          email_enabled BOOLEAN DEFAULT false,\n          email_address VARCHAR(255),\n          temp_critical_low DECIMAL DEFAULT 18,\n          temp_critical_high DECIMAL DEFAULT 30,\n          humidity_critical_low DECIMAL DEFAULT 40,\n          humidity_critical_high DECIMAL DEFAULT 90,\n          notification_cooldown_minutes INTEGER DEFAULT 60,\n          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n      `;\n      dbStatus.notification_settings = true;\n\n      // Initial Settings\n      const result = await sql`SELECT COUNT(*) as count FROM notification_settings`;\n      if (result.rows[0].count === '0') {\n        await sql`\n          INSERT INTO notification_settings (push_enabled, email_enabled)\n          VALUES (false, false)\n        `;\n        dbStatus.initial_settings = true;\n      } else {\n        dbStatus.initial_settings = true; // Already exists\n      }\n\n    } catch (dbError) {\n      console.error('Database setup error:', dbError);\n    }\n\n    // HTML Response mit Keys zum Kopieren\n    return new Response(\n      `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <title>FlitzHQ Push Notifications Setup</title>\n        <style>\n          body {\n            font-family: system-ui, -apple-system, sans-serif;\n            max-width: 900px;\n            margin: 50px auto;\n            padding: 20px;\n            background: #0f172a;\n            color: #e2e8f0;\n          }\n          .container {\n            background: #1e293b;\n            border-radius: 12px;\n            padding: 30px;\n            border: 1px solid #334155;\n          }\n          h1 { color: #10b981; margin-top: 0; }\n          h2 { color: #60a5fa; margin-top: 30px; }\n          .key-box {\n            background: #0f172a;\n            border: 2px solid #334155;\n            border-radius: 8px;\n            padding: 15px;\n            margin: 15px 0;\n            font-family: 'Monaco', 'Courier New', monospace;\n            font-size: 12px;\n            word-break: break-all;\n            cursor: pointer;\n            transition: border-color 0.2s;\n          }\n          .key-box:hover {\n            border-color: #10b981;\n          }\n          .key-label {\n            color: #94a3b8;\n            font-size: 11px;\n            text-transform: uppercase;\n            margin-bottom: 8px;\n            font-weight: 600;\n          }\n          .key-value {\n            color: #10b981;\n            user-select: all;\n          }\n          .status {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            margin: 10px 0;\n            padding: 10px;\n            background: #0f172a;\n            border-radius: 6px;\n          }\n          .status-icon {\n            font-size: 20px;\n          }\n          .success { color: #10b981; }\n          .error { color: #ef4444; }\n          .instructions {\n            background: #334155;\n            padding: 20px;\n            border-radius: 8px;\n            margin-top: 30px;\n          }\n          .instructions ol {\n            margin: 15px 0;\n            padding-left: 25px;\n          }\n          .instructions li {\n            margin: 10px 0;\n            line-height: 1.6;\n          }\n          .copy-btn {\n            background: #10b981;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 12px;\n            margin-top: 10px;\n          }\n          .copy-btn:hover {\n            background: #059669;\n          }\n          code {\n            background: #0f172a;\n            padding: 2px 6px;\n            border-radius: 4px;\n            color: #10b981;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <h1>\ud83d\udd14 FlitzHQ Push Notifications Setup</h1>\n\n          <h2>\ud83d\udcca Setup Status</h2>\n          <div class=\"status\">\n            <span class=\"status-icon\">\u2705</span>\n            <span class=\"success\">VAPID Keys generiert</span>\n          </div>\n          <div class=\"status\">\n            <span class=\"status-icon\">${dbStatus.push_subscriptions ? '\u2705' : '\u274c'}</span>\n            <span class=\"${dbStatus.push_subscriptions ? 'success' : 'error'}\">\n              Tabelle: push_subscriptions ${dbStatus.push_subscriptions ? 'erstellt' : 'Fehler'}\n            </span>\n          </div>\n          <div class=\"status\">\n            <span class=\"status-icon\">${dbStatus.notification_settings ? '\u2705' : '\u274c'}</span>\n            <span class=\"${dbStatus.notification_settings ? 'success' : 'error'}\">\n              Tabelle: notification_settings ${dbStatus.notification_settings ? 'erstellt' : 'Fehler'}\n            </span>\n          </div>\n          <div class=\"status\">\n            <span class=\"status-icon\">${dbStatus.initial_settings ? '\u2705' : '\u274c'}</span>\n            <span class=\"${dbStatus.initial_settings ? 'success' : 'error'}\">\n              Initial Settings ${dbStatus.initial_settings ? 'erstellt' : 'Fehler'}\n            </span>\n          </div>\n\n          <h2>\ud83d\udd11 Environment Variables</h2>\n          <p>Kopiere diese beiden Variables in Vercel Dashboard \u2192 Settings \u2192 Environment Variables:</p>\n\n          <div class=\"key-box\" onclick=\"copyToClipboard('public-key')\">\n            <div class=\"key-label\">NEXT_PUBLIC_VAPID_PUBLIC_KEY</div>\n            <div class=\"key-value\" id=\"public-key\">${vapidKeys.publicKey}</div>\n            <button class=\"copy-btn\" onclick=\"event.stopPropagation(); copyToClipboard('public-key')\">\n              Kopieren\n            </button>\n          </div>\n\n          <div class=\"key-box\" onclick=\"copyToClipboard('private-key')\">\n            <div class=\"key-label\">VAPID_PRIVATE_KEY</div>\n            <div class=\"key-value\" id=\"private-key\">${vapidKeys.privateKey}</div>\n            <button class=\"copy-btn\" onclick=\"event.stopPropagation(); copyToClipboard('private-key')\">\n              Kopieren\n            </button>\n          </div>\n\n          <div class=\"instructions\">\n            <h3>\ud83d\udcdd N\u00e4chste Schritte:</h3>\n            <ol>\n              <li>\n                \u00d6ffne <strong>Vercel Dashboard</strong> \u2192 Dein Projekt \u2192\n                <strong>Settings</strong> \u2192 <strong>Environment Variables</strong>\n              </li>\n              <li>\n                F\u00fcge <code>NEXT_PUBLIC_VAPID_PUBLIC_KEY</code> hinzu (Public Key von oben kopieren)\n              </li>\n              <li>\n                F\u00fcge <code>VAPID_PRIVATE_KEY</code> hinzu (Private Key von oben kopieren)\n              </li>\n              <li>\n                Beide f\u00fcr <strong>Production</strong>, <strong>Preview</strong> und\n                <strong>Development</strong> setzen\n              </li>\n              <li>\n                <strong>Redeploy ausl\u00f6sen</strong> (Deployments \u2192 ... \u2192 Redeploy)\n              </li>\n              <li>\n                Nach Deploy: FlitzHQ \u00f6ffnen \u2192 Settings \u2192 Benachrichtigungen \u2192\n                <strong>Push aktivieren</strong>\n              </li>\n            </ol>\n          </div>\n\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;\">\n            <a href=\"/\" style=\"color: #10b981; text-decoration: none;\">\n              \u2190 Zur\u00fcck zum Dashboard\n            </a>\n          </div>\n        </div>\n\n        <script>\n          function copyToClipboard(elementId) {\n            const element = document.getElementById(elementId);\n            const text = element.textContent;\n            navigator.clipboard.writeText(text).then(() => {\n              const btn = element.parentElement.querySelector('.copy-btn');\n              const originalText = btn.textContent;\n              btn.textContent = '\u2713 Kopiert!';\n              setTimeout(() => {\n                btn.textContent = originalText;\n              }, 2000);\n            });\n          }\n        </script>\n      </body>\n      </html>\n      `,\n      {\n        headers: { 'Content-Type': 'text/html' },\n      }\n    );\n\n  } catch (error) {\n    console.error('Setup error:', error);\n    return NextResponse.json({\n      error: 'Setup failed',\n      message: error.message\n    }, { status: 500 });\n  }\n}\n",
      "content_hash": "2e45ed24a4e0547446b8af1c181c2b7f",
      "lines": 321
    },
    "app/api/status/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/status/route.js",
      "relative_path": "app/api/status/route.js",
      "size": 396,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { getShellyStatus } from '@/lib/shellyStatus';\n\nexport async function GET() {\n  try {\n    const payload = await getShellyStatus();\n    return NextResponse.json(payload);\n  } catch (error) {\n    return NextResponse.json({\n      success: false,\n      error: error.message || 'Unbekannter Fehler'\n    }, { status: error.statusCode || 500 });\n  }\n}\n",
      "content_hash": "f2fb55b6a510af19462f37b44da38168",
      "lines": 15
    },
    "app/api/push/subscribe/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/push/subscribe/route.js",
      "relative_path": "app/api/push/subscribe/route.js",
      "size": 1548,
      "extension": ".js",
      "is_code": true,
      "content": "import { sql } from '@vercel/postgres';\nimport { NextResponse } from 'next/server';\n\nexport async function POST(request) {\n  try {\n    const subscription = await request.json();\n\n    if (!subscription.endpoint || !subscription.keys) {\n      return NextResponse.json(\n        { error: 'Invalid subscription data' },\n        { status: 400 }\n      );\n    }\n\n    const userAgent = request.headers.get('user-agent') || 'Unknown';\n\n    await sql`\n      INSERT INTO push_subscriptions (endpoint, keys, user_agent)\n      VALUES (\n        ${subscription.endpoint},\n        ${JSON.stringify(subscription.keys)},\n        ${userAgent}\n      )\n      ON CONFLICT (endpoint)\n      DO UPDATE SET\n        keys = ${JSON.stringify(subscription.keys)},\n        user_agent = ${userAgent}\n    `;\n\n    return NextResponse.json({\n      success: true,\n      message: 'Push subscription saved'\n    });\n  } catch (error) {\n    console.error('Error saving subscription:', error);\n    return NextResponse.json(\n      { error: 'Failed to save subscription' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(request) {\n  try {\n    const { endpoint } = await request.json();\n\n    await sql`\n      DELETE FROM push_subscriptions\n      WHERE endpoint = ${endpoint}\n    `;\n\n    return NextResponse.json({\n      success: true,\n      message: 'Subscription removed'\n    });\n  } catch (error) {\n    console.error('Error removing subscription:', error);\n    return NextResponse.json(\n      { error: 'Failed to remove subscription' },\n      { status: 500 }\n    );\n  }\n}\n",
      "content_hash": "8136a1a973b4636e46b18beb0ffd32a2",
      "lines": 64
    },
    "app/api/sensor/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/sensor/route.js",
      "relative_path": "app/api/sensor/route.js",
      "size": 2917,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport crypto from 'crypto';\n\n// In-Memory Cache (Serverless-compatible)\nlet cache = {\n  data: null,\n  timestamp: 0\n};\n\nconst CACHE_DURATION_MS = 30000; // 30 Sekunden Cache\n\nexport async function GET() {\n  const apiKey = process.env.GOVEE_API_KEY;\n  const deviceId = process.env.GOVEE_MAC_ADDRESS;\n  const sku = \"H5179\";\n\n  if (!apiKey || !deviceId) {\n    return NextResponse.json({ \n      error: 'Konfiguration fehlt',\n      details: 'GOVEE_API_KEY oder GOVEE_MAC_ADDRESS nicht gesetzt'\n    }, { status: 500 });\n  }\n\n  // Cache Check\n  const now = Date.now();\n  const cacheAge = now - cache.timestamp;\n\n  if (cache.data && cacheAge < CACHE_DURATION_MS) {\n    console.log(`[CACHE HIT] Govee Sensor (age: ${Math.round(cacheAge / 1000)}s)`);\n    return NextResponse.json({\n      ...cache.data,\n      cached: true,\n      cacheAge: Math.round(cacheAge / 1000)\n    });\n  }\n\n  // Cache Miss - API Call\n  console.log('[CACHE MISS] Fetching from Govee API');\n\n  try {\n    const requestId = crypto.randomUUID();\n\n    const payload = {\n      requestId: requestId,\n      payload: {\n        sku: sku,\n        device: deviceId\n      }\n    };\n\n    const response = await fetch('https://openapi.api.govee.com/router/api/v1/device/state', {\n      method: 'POST',\n      headers: {\n        'Govee-API-Key': apiKey,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(payload),\n      signal: AbortSignal.timeout(10000) // 10s Timeout\n    });\n\n    if (!response.ok) {\n      throw new Error(`Govee API returned ${response.status}: ${response.statusText}`);\n    }\n\n    const json = await response.json();\n\n    let temp = 0;\n    let hum = 0;\n\n    if (json.payload && json.payload.capabilities) {\n      const tempCap = json.payload.capabilities.find(c => c.instance === 'sensorTemperature');\n      const humCap = json.payload.capabilities.find(c => c.instance === 'sensorHumidity');\n\n      if (tempCap) temp = tempCap.state.value;\n      if (humCap) hum = humCap.state.value;\n    }\n\n    const tempCelsius = (temp - 32) * (5 / 9);\n\n    const result = {\n      data: {\n        properties: [\n          { temperature: tempCelsius.toFixed(1) },\n          { humidity: hum }\n        ]\n      },\n      cached: false,\n      timestamp: new Date().toISOString()\n    };\n\n    // Update Cache\n    cache.data = result;\n    cache.timestamp = now;\n\n    return NextResponse.json(result);\n\n  } catch (error) {\n    console.error('[GOVEE API ERROR]', error.message);\n    \n    // Fallback: Return stale cache if available\n    if (cache.data) {\n      console.log('[STALE CACHE] Returning old data due to error');\n      return NextResponse.json({\n        ...cache.data,\n        cached: true,\n        stale: true,\n        error: error.message\n      });\n    }\n\n    return NextResponse.json({ \n      error: 'Govee API nicht erreichbar',\n      details: error.message \n    }, { status: 503 });\n  }\n}\n",
      "content_hash": "71e97f83dd8687ee36aa7e7b0a3cb333",
      "lines": 117
    },
    "app/api/db-setup/events/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/db-setup/events/route.js",
      "relative_path": "app/api/db-setup/events/route.js",
      "size": 921,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\n\nexport async function GET() {\n  try {\n    await sql`\n      CREATE TABLE IF NOT EXISTS device_events (\n        id SERIAL PRIMARY KEY,\n        timestamp TIMESTAMP DEFAULT NOW(),\n        device TEXT NOT NULL,\n        action TEXT NOT NULL,\n        source TEXT DEFAULT 'user',\n        metadata JSONB\n      );\n    `;\n\n    await sql`\n      CREATE INDEX IF NOT EXISTS idx_device_events_timestamp \n      ON device_events(timestamp DESC);\n    `;\n\n    await sql`\n      CREATE INDEX IF NOT EXISTS idx_device_events_device \n      ON device_events(device, timestamp DESC);\n    `;\n\n    return NextResponse.json({ \n      success: true,\n      message: 'Events table created successfully'\n    });\n\n  } catch (error) {\n    console.error('DB Setup Error:', error);\n    return NextResponse.json({ \n      error: error.message \n    }, { status: 500 });\n  }\n}\n",
      "content_hash": "3dc9bd0448c29ef688c150eb37badac8",
      "lines": 39
    },
    "app/api/history/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/history/route.js",
      "relative_path": "app/api/history/route.js",
      "size": 3182,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\n\n// Cache f\u00fcr History Queries\nconst historyCache = new Map();\nconst HISTORY_CACHE_DURATION_MS = 120000; // 2 Minuten Cache\n\nexport async function GET(request) {\n  const { searchParams } = new URL(request.url);\n  const range = searchParams.get('range') || '24h';\n\n  // Cache Key\n  const cacheKey = `history_${range}`;\n  const cached = historyCache.get(cacheKey);\n  const now = Date.now();\n\n  // Cache Hit\n  if (cached && (now - cached.timestamp) < HISTORY_CACHE_DURATION_MS) {\n    console.log(`[CACHE HIT] History ${range}`);\n    return NextResponse.json(cached.data);\n  }\n\n  console.log(`[CACHE MISS] Fetching History ${range}`);\n\n  try {\n    let query;\n    \n    // Hinweis: Wir runden timestamps auf volle Stunden/Minuten f\u00fcr saubere Graphen\n    if (range === '24h') {\n        query = sql`\n            SELECT timestamp, temperature, humidity, light_status, heater_status \n            FROM readings \n            WHERE timestamp > NOW() - INTERVAL '24 hours' \n            ORDER BY timestamp ASC;`;\n    } else if (range === '7d') {\n        query = sql`\n            SELECT date_trunc('hour', timestamp) as timestamp, \n                   AVG(temperature) as temperature, \n                   AVG(humidity) as humidity,\n                   BOOL_OR(light_status) as light_status, -- War irgendwann in der Stunde an?\n                   BOOL_OR(heater_status) as heater_status\n            FROM readings \n            WHERE timestamp > NOW() - INTERVAL '7 days' \n            GROUP BY timestamp \n            ORDER BY timestamp ASC;`;\n    } else {\n        // 30 Tage (4h Intervalle)\n        query = sql`\n            SELECT to_timestamp(floor((extract('epoch' from timestamp) / 14400 )) * 14400) as timestamp, \n                   AVG(temperature) as temperature, \n                   AVG(humidity) as humidity,\n                   BOOL_OR(light_status) as light_status,\n                   BOOL_OR(heater_status) as heater_status\n            FROM readings \n            WHERE timestamp > NOW() - INTERVAL '30 days' \n            GROUP BY timestamp \n            ORDER BY 1 ASC;`;\n    }\n\n    const result = await query;\n\n    const formatted = result.rows.map(row => ({\n      time: row.timestamp,\n      temp: row.temperature ? Number(row.temperature).toFixed(1) : null,\n      humidity: row.humidity ? parseFloat(Number(row.humidity).toFixed(1)) : null,\n      light: row.light_status,\n      heater: row.heater_status\n    }));\n\n    // Update Cache\n    historyCache.set(cacheKey, {\n      data: formatted,\n      timestamp: now\n    });\n\n    // Cleanup alte Cache Entries (max 10)\n    if (historyCache.size > 10) {\n      const firstKey = historyCache.keys().next().value;\n      historyCache.delete(firstKey);\n    }\n\n    return NextResponse.json(formatted);\n\n  } catch (error) {\n    console.error(error);\n    \n    // Return stale cache if available\n    if (cached) {\n      console.log('[STALE CACHE] Returning old history data');\n      return NextResponse.json(cached.data);\n    }\n    \n    return NextResponse.json({ \n      error: 'Verlaufsdaten nicht verf\u00fcgbar',\n      details: error.message \n    }, { status: 500 });\n  }\n}\n",
      "content_hash": "f2e76d78e88ea4053c4db980af887251",
      "lines": 99
    },
    "app/api/light-schedule/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/light-schedule/route.js",
      "relative_path": "app/api/light-schedule/route.js",
      "size": 1796,
      "extension": ".js",
      "is_code": true,
      "content": "import { sql } from '@vercel/postgres';\nimport { NextResponse } from 'next/server';\n\n// GET: Schedule abrufen\nexport async function GET() {\n  try {\n    const result = await sql`\n      SELECT * FROM light_schedule \n      ORDER BY id DESC \n      LIMIT 1\n    `;\n\n    const schedule = result.rows[0] || {\n      enabled: false,\n      time_on: '08:00',\n      time_off: '20:00'\n    };\n\n    return NextResponse.json(schedule);\n  } catch (error) {\n    console.error('Error fetching schedule:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch schedule' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST: Schedule aktualisieren\nexport async function POST(request) {\n  try {\n    const { enabled, time_on, time_off } = await request.json();\n\n    if (typeof enabled !== 'boolean' || !time_on || !time_off) {\n      return NextResponse.json(\n        { error: 'Invalid schedule data' },\n        { status: 400 }\n      );\n    }\n\n    const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;\n    if (!timeRegex.test(time_on) || !timeRegex.test(time_off)) {\n      return NextResponse.json(\n        { error: 'Invalid time format. Use HH:MM' },\n        { status: 400 }\n      );\n    }\n\n    await sql`\n      INSERT INTO light_schedule (id, enabled, time_on, time_off, updated_at)\n      VALUES (1, ${enabled}, ${time_on}, ${time_off}, NOW())\n      ON CONFLICT (id) \n      DO UPDATE SET \n        enabled = ${enabled},\n        time_on = ${time_on},\n        time_off = ${time_off},\n        updated_at = NOW()\n    `;\n\n    return NextResponse.json({\n      success: true,\n      message: 'Schedule updated successfully'\n    });\n  } catch (error) {\n    console.error('Error updating schedule:', error);\n    return NextResponse.json(\n      { error: 'Failed to update schedule' },\n      { status: 500 }\n    );\n  }\n}\n",
      "content_hash": "6e342579feb31da716e84a4961b12637",
      "lines": 72
    },
    "app/api/events/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/events/route.js",
      "relative_path": "app/api/events/route.js",
      "size": 2589,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\n\n// In-Memory Cache\nlet eventsCache = new Map();\nconst CACHE_DURATION_MS = 120000; // 2 Minuten\n\nexport async function GET(request) {\n  const { searchParams } = new URL(request.url);\n  \n  // Query Parameters\n  const hours = parseInt(searchParams.get('hours')) || 24;\n  const device = searchParams.get('device'); // 'light', 'heater', oder null f\u00fcr beide\n  \n  // Cache Key\n  const cacheKey = `${device || 'all'}-${hours}`;\n  const cached = eventsCache.get(cacheKey);\n  const now = Date.now();\n\n  // Cache Check\n  if (cached && (now - cached.timestamp < CACHE_DURATION_MS)) {\n    console.log(`[CACHE HIT] Events (${cacheKey})`);\n    return NextResponse.json({\n      events: cached.data,\n      cached: true,\n      cacheAge: Math.round((now - cached.timestamp) / 1000)\n    });\n  }\n\n  console.log(`[CACHE MISS] Fetching events (${cacheKey})`);\n\n  try {\n    // FIX: Berechne Cutoff-Zeit in JavaScript statt SQL INTERVAL\n    const cutoffTime = new Date(Date.now() - hours * 60 * 60 * 1000);\n\n    // SQL Query mit optionalem Device-Filter\n    const query = device\n      ? sql`\n          SELECT * FROM device_events\n          WHERE timestamp > ${cutoffTime}\n            AND device = ${device}\n          ORDER BY timestamp DESC\n          LIMIT 500;\n        `\n      : sql`\n          SELECT * FROM device_events\n          WHERE timestamp > ${cutoffTime}\n          ORDER BY timestamp DESC\n          LIMIT 500;\n        `;\n\n    const { rows } = await query;\n\n    // Format Events\n    const formatted = rows.map(row => ({\n      id: row.id,\n      timestamp: row.timestamp,\n      device: row.device,\n      action: row.action,\n      source: row.source,\n      metadata: row.metadata\n    }));\n\n    // Update Cache\n    eventsCache.set(cacheKey, {\n      data: formatted,\n      timestamp: now\n    });\n\n    // Cleanup alte Cache Entries\n    if (eventsCache.size > 10) {\n      const firstKey = eventsCache.keys().next().value;\n      eventsCache.delete(firstKey);\n    }\n\n    return NextResponse.json({\n      events: formatted,\n      cached: false,\n      count: formatted.length\n    });\n\n  } catch (error) {\n    console.error('[EVENTS API ERROR]', error);\n\n    // Fallback: Stale Cache\n    if (cached) {\n      console.log('[STALE CACHE] Returning old events data');\n      return NextResponse.json({\n        events: cached.data,\n        cached: true,\n        stale: true\n      });\n    }\n\n    return NextResponse.json({ \n      error: 'Events konnten nicht geladen werden',\n      details: error.message \n    }, { status: 500 });\n  }\n}\n",
      "content_hash": "87eb1ebbc940b0e31bb9d692e57865d5",
      "lines": 101
    },
    "app/api/shelly/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/shelly/route.js",
      "relative_path": "app/api/shelly/route.js",
      "size": 3061,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\nimport { getShellyStatus, invalidateShellyCache, refreshShellyCache } from '@/lib/shellyStatus';\n\nexport async function GET() {\n  try {\n    const status = await getShellyStatus();\n    return NextResponse.json(status);\n  } catch (error) {\n    return NextResponse.json({\n      success: false,\n      error: error.message || 'Shelly Status nicht verf\u00fcgbar'\n    }, { status: error.statusCode || 500 });\n  }\n}\n\nexport async function POST(request) {\n  try {\n    const { target, action } = await request.json();\n\n    if (!target || !action) {\n      return NextResponse.json({ \n        error: 'Fehlende Parameter',\n        details: 'target und action sind erforderlich'\n      }, { status: 400 });\n    }\n\n    const authKey = process.env.SHELLY_CLOUD_KEY;\n    const server = process.env.SHELLY_SERVER;\n\n    let deviceId = '';\n    let deviceName = '';\n    if (target === 'light') {\n      deviceId = process.env.SHELLY_LIGHT_ID;\n      deviceName = 'Tageslicht';\n    }\n    if (target === 'heater') {\n      deviceId = process.env.SHELLY_HEATER_ID;\n      deviceName = 'Heizung';\n    }\n\n    if (!authKey || !deviceId || !server) {\n      return NextResponse.json({ \n        error: `Shelly Konfiguration unvollst\u00e4ndig f\u00fcr ${target}`,\n        details: 'Device ID oder Auth Key fehlt'\n      }, { status: 500 });\n    }\n\n    const turn = action === 'on' ? 'on' : 'off';\n    const formData = new URLSearchParams();\n    formData.append('channel', '0');\n    formData.append('turn', turn);\n    formData.append('id', deviceId);\n    formData.append('auth_key', authKey);\n\n    const response = await fetch(`${server}/device/relay/control`, {\n      method: 'POST',\n      body: formData,\n      signal: AbortSignal.timeout(8000)\n    });\n\n    if (!response.ok) {\n      throw new Error(`Shelly Cloud returned ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    if (!data.isok) {\n      console.error('[SHELLY CONTROL ERROR]', data);\n      throw new Error(data.errors?.[0] || 'Schaltvorgang fehlgeschlagen');\n    }\n\n    console.log(`[SHELLY CONTROL SUCCESS] ${deviceName} \u2192 ${turn}`);\n\n    invalidateShellyCache();\n    await refreshShellyCache();\n\n    // Log Event to Database\n    try {\n      await sql`\n        INSERT INTO device_events (device, action, source, metadata)\n        VALUES (\n          ${target},\n          ${turn},\n          'user',\n          ${JSON.stringify({\n            deviceId,\n            timestamp: new Date().toISOString()\n          })}\n        );\n      `;\n      console.log(`[EVENT LOGGED] ${target} turned ${turn}`);\n    } catch (eventError) {\n      // Event-Logging darf Control nicht blockieren\n      console.error('[EVENT LOG ERROR]', eventError);\n    }\n\n    return NextResponse.json({\n      success: true,\n      target,\n      state: turn\n    });\n\n  } catch (error) {\n    console.error('[SHELLY CONTROL ERROR]', error);\n    return NextResponse.json({ \n      error: 'Schaltvorgang fehlgeschlagen',\n      details: error.message \n    }, { status: 500 });\n  }\n}\n",
      "content_hash": "22536839ef6c82cfe6c3579468eeca42",
      "lines": 112
    },
    "app/api/cron/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/cron/route.js",
      "relative_path": "app/api/cron/route.js",
      "size": 7006,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\nimport { getShellyStatus } from '@/lib/shellyStatus';\nimport { sendCriticalAlert } from '@/lib/pushService';\n\n// Helper: Fetch mit Timeout (9s f\u00fcr externe Trigger)\nconst fetchWithTimeout = async (url, options = {}, timeout = 9000) => {\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), timeout);\n  try {\n    const response = await fetch(url, { ...options, signal: controller.signal });\n    clearTimeout(id);\n    return response;\n  } catch (error) {\n    clearTimeout(id);\n    throw error;\n  }\n};\n\nexport async function GET(request) {\n  // --- SECURITY CHECK ---\n  const { searchParams } = new URL(request.url);\n  const key = searchParams.get('key');\n  \n  // Security Token (Fallback hardcoded f\u00fcr einfachen Setup)\n  const secret = process.env.CRON_SECRET || 'gecko_secure_123';\n\n  if (key !== secret) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  // --- LOGIC ---\n  try {\n    console.log(`[EXTERNAL CRON] Starting run...`);\n\n    // 1. Govee Daten holen (Router API)\n    const goveePromise = (async () => {\n        try {\n            const res = await fetchWithTimeout('https://openapi.api.govee.com/router/api/v1/device/state', {\n                method: 'POST',\n                headers: {\n                    'Govee-API-Key': process.env.GOVEE_API_KEY,\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify({\n                    requestId: 'cron-' + Date.now(),\n                    payload: { sku: \"H5179\", device: process.env.GOVEE_MAC_ADDRESS }\n                })\n            });\n            const json = await res.json();\n            if (json.payload?.capabilities) {\n                const t = json.payload.capabilities.find(c => c.instance === 'sensorTemperature');\n                const h = json.payload.capabilities.find(c => c.instance === 'sensorHumidity');\n                return {\n                    temp: t ? (Number(t.state.value) - 32) * (5/9) : null,\n                    hum: h ? Number(h.state.value) : null\n                };\n            }\n        } catch (e) {\n            console.error(\"[CRON] Govee Error:\", e.message);\n        }\n        return null;\n    })();\n\n    // 2. Shelly Daten holen (Gen 2/3 Support)\n    const shellyPromise = (async () => {\n        try {\n            const status = await getShellyStatus({ forceRefresh: true });\n\n            if (!status.allVerified) {\n                throw new Error('Shelly Status nicht verifiziert');\n            }\n\n            return status.status;\n        } catch (e) {\n            console.error('[CRON] Shelly Error:', e.message);\n            return null;\n        }\n    })();\n\n    const [goveeData, shellyData] = await Promise.all([goveePromise, shellyPromise]);\n\n    // Auto-Event Logging bei Status-\u00c4nderung\n    try {\n      const { rows } = await sql`\n        SELECT light_status, heater_status \n        FROM readings \n        ORDER BY timestamp DESC \n        LIMIT 1;\n      `;\n\n      const lastState = rows[0] || { light_status: false, heater_status: false };\n      const lightStatus = shellyData ? shellyData.light : null;\n      const heaterStatus = shellyData ? shellyData.heater : null;\n\n      if (lightStatus !== null && lightStatus !== lastState.light_status) {\n        await sql`\n          INSERT INTO device_events (device, action, source)\n          VALUES ('light', ${lightStatus ? 'on' : 'off'}, 'automation');\n        `;\n        console.log(`[AUTO EVENT] Light changed to ${lightStatus}`);\n      }\n\n      if (heaterStatus !== null && heaterStatus !== lastState.heater_status) {\n        await sql`\n          INSERT INTO device_events (device, action, source)\n          VALUES ('heater', ${heaterStatus ? 'on' : 'off'}, 'automation');\n        `;\n        console.log(`[AUTO EVENT] Heater changed to ${heaterStatus}`);\n      }\n\n    } catch (e) {\n      console.error('[AUTO EVENT ERROR]', e);\n      // Nicht kritisch, weiter machen\n    }\n\n    // 3. Speichern\n    if (goveeData && goveeData.temp !== null) {\n        if (!shellyData) {\n            return NextResponse.json({ error: \"Shelly Status unverifiziert\" }, { status: 503 });\n        }\n        // Table check (Self-Healing)\n        await sql`CREATE TABLE IF NOT EXISTS readings (\n            id SERIAL PRIMARY KEY,\n            timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n            temperature NUMERIC(5,2),\n            humidity NUMERIC(5,2),\n            light_status BOOLEAN,\n            heater_status BOOLEAN\n        );`;\n\n        const result = await sql`\n            INSERT INTO readings (temperature, humidity, light_status, heater_status) \n            VALUES (${goveeData.temp.toFixed(2)}, ${goveeData.hum}, ${shellyData.light}, ${shellyData.heater})\n            RETURNING id;\n        `;\n\n        // NEU: Push Notification Check\n        try {\n          const settingsResult = await sql`\n            SELECT * FROM notification_settings\n            WHERE push_enabled = true\n            ORDER BY id DESC\n            LIMIT 1\n          `;\n\n          if (settingsResult.rows.length > 0) {\n            const settings = settingsResult.rows[0];\n\n            // Cooldown check\n            const lastNotification = settings.updated_at ? new Date(settings.updated_at) : null;\n            const now = new Date();\n            const minutesSinceLastNotification = lastNotification\n              ? (now - lastNotification) / 1000 / 60\n              : 999;\n\n            if (minutesSinceLastNotification >= settings.notification_cooldown_minutes) {\n              const temperature = Number(goveeData.temp);\n              const humidity = Number(goveeData.hum);\n\n              // Temperature check\n              if (temperature < settings.temp_critical_low) {\n                await sendCriticalAlert('temp_low', temperature, settings.temp_critical_low);\n              } else if (temperature > settings.temp_critical_high) {\n                await sendCriticalAlert('temp_high', temperature, settings.temp_critical_high);\n              }\n\n              // Humidity check\n              if (humidity < settings.humidity_critical_low) {\n                await sendCriticalAlert('humidity_low', humidity, settings.humidity_critical_low);\n              } else if (humidity > settings.humidity_critical_high) {\n                await sendCriticalAlert('humidity_high', humidity, settings.humidity_critical_high);\n              }\n            }\n          }\n        } catch (notificationError) {\n          console.error('Notification check failed:', notificationError);\n          // Don't throw - sensor data is more important\n        }\n\n        return NextResponse.json({ success: true, id: result.rows[0].id, data: { ...goveeData, ...shellyData } });\n    } else {\n        return NextResponse.json({ error: \"No Sensor Data\" }, { status: 500 });\n    }\n\n  } catch (error) {\n    return NextResponse.json({ error: error.toString() }, { status: 500 });\n  }\n}\n",
      "content_hash": "b66f63b16949d7c3247382bda14d066a",
      "lines": 190
    },
    "app/api/cron/check-light-schedule/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/cron/check-light-schedule/route.js",
      "relative_path": "app/api/cron/check-light-schedule/route.js",
      "size": 3047,
      "extension": ".js",
      "is_code": true,
      "content": "import { sql } from '@vercel/postgres';\nimport { NextResponse } from 'next/server';\n\nconst SHELLY_DEVICE_ID = process.env.SHELLY_LIGHT_ID;\nconst SHELLY_API_KEY = process.env.SHELLY_API_KEY;\n\nexport async function GET(request) {\n  const authHeader = request.headers.get('authorization');\n  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  try {\n    const scheduleResult = await sql`\n      SELECT * FROM light_schedule \n      WHERE enabled = true\n      ORDER BY id DESC \n      LIMIT 1\n    `;\n\n    if (scheduleResult.rows.length === 0) {\n      return NextResponse.json({\n        message: 'Schedule disabled or not found'\n      });\n    }\n\n    const schedule = scheduleResult.rows[0];\n\n    const now = new Date();\n    const viennaTime = new Intl.DateTimeFormat('de-AT', {\n      timeZone: 'Europe/Vienna',\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: false\n    }).format(now);\n\n    console.log('Current time:', viennaTime);\n    console.log('Schedule ON:', schedule.time_on, 'OFF:', schedule.time_off);\n\n    let action = null;\n    let targetState = null;\n\n    if (viennaTime === schedule.time_on) {\n      action = 'turn_on';\n      targetState = 'on';\n    } else if (viennaTime === schedule.time_off) {\n      action = 'turn_off';\n      targetState = 'off';\n    }\n\n    if (!action) {\n      return NextResponse.json({\n        message: 'No action needed',\n        current_time: viennaTime\n      });\n    }\n\n    // Deduplizierung: Check ob bereits ausgef\u00fchrt\n    if (schedule.last_action === action && schedule.last_action_time) {\n      const lastActionTime = new Date(schedule.last_action_time);\n      const timeSinceLastAction = now - lastActionTime;\n\n      if (timeSinceLastAction < 120000) {\n        return NextResponse.json({\n          message: 'Action already executed recently',\n          last_action: action,\n          time_since: `${Math.round(timeSinceLastAction / 1000)}s`\n        });\n      }\n    }\n\n    const shellyUrl = 'https://shelly-56-eu.shelly.cloud/device/relay/control';\n    const shellyResponse = await fetch(shellyUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: new URLSearchParams({\n        auth_key: SHELLY_API_KEY,\n        id: SHELLY_DEVICE_ID,\n        channel: '0',\n        turn: targetState\n      })\n    });\n\n    if (!shellyResponse.ok) {\n      throw new Error(`Shelly API error: ${shellyResponse.status}`);\n    }\n\n    const shellyData = await shellyResponse.json();\n\n    await sql`\n      UPDATE light_schedule \n      SET \n        last_action = ${action},\n        last_action_time = NOW()\n      WHERE id = ${schedule.id}\n    `;\n\n    return NextResponse.json({\n      success: true,\n      action: action,\n      time: viennaTime,\n      shelly_response: shellyData\n    });\n  } catch (error) {\n    console.error('Error in light schedule check:', error);\n    return NextResponse.json(\n      { error: error.message },\n      { status: 500 }\n    );\n  }\n}\n",
      "content_hash": "2ef49f6dddfb3dcb36bbe2eaf669c899",
      "lines": 114
    },
    "app/api/debug/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/debug/route.js",
      "relative_path": "app/api/debug/route.js",
      "size": 1129,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\n\n// Deaktiviert Caching f\u00fcr diese Route komplett\nexport const dynamic = 'force-dynamic';\n\nexport async function GET() {\n  try {\n    // 1. Pr\u00fcfen ob Tabelle existiert\n    // (Information schema query)\n    const tableCheck = await sql`\n      SELECT exists(\n        SELECT FROM information_schema.tables \n        WHERE table_name = 'readings'\n      );\n    `;\n    \n    const tableExists = tableCheck.rows[0].exists;\n\n    if (!tableExists) {\n        console.log(\"DEBUG: Tabelle 'readings' existiert NICHT!\");\n        return NextResponse.json({ error: \"Table 'readings' does not exist\" });\n    }\n\n    // 2. Die letzten 20 Eintr\u00e4ge holen\n    const result = await sql`\n      SELECT * FROM readings ORDER BY timestamp DESC LIMIT 20;\n    `;\n\n    console.log(\"DEBUG: Database Dump (Last 20):\", result.rows);\n\n    return NextResponse.json({ \n        count: result.rowCount,\n        rows: result.rows \n    });\n\n  } catch (error) {\n    console.error(\"DEBUG ERROR:\", error);\n    return NextResponse.json({ error: error.toString() }, { status: 500 });\n  }\n}\n",
      "content_hash": "9f1dfb8981ed32f117ed5fb4a9689be0",
      "lines": 42
    },
    "app/api/db-migrate/route.js": {
      "path": "/Users/marcus.braun/repos/geckohub/app/api/db-migrate/route.js",
      "relative_path": "app/api/db-migrate/route.js",
      "size": 3234,
      "extension": ".js",
      "is_code": true,
      "content": "import { NextResponse } from 'next/server';\nimport { sql } from '@vercel/postgres';\n\nexport async function GET() {\n  try {\n    console.log('[DB MIGRATE] Starting migration...');\n\n    // 1. Pr\u00fcfen welche Spalten existieren\n    const columnsCheck = await sql`\n      SELECT column_name, data_type \n      FROM information_schema.columns \n      WHERE table_name = 'readings'\n      ORDER BY ordinal_position;\n    `;\n\n    const columns = columnsCheck.rows.map((r) => r.column_name);\n    console.log('[DB MIGRATE] Current columns:', columns);\n\n    // 2. Pr\u00fcfen ob alte Struktur vorhanden\n    const hasOldStructure = columns.includes('light_power') || columns.includes('heater_power');\n    const hasNewStructure = columns.includes('light_status') && columns.includes('heater_status');\n\n    if (hasOldStructure && !hasNewStructure) {\n      console.log('[DB MIGRATE] Old structure detected, migrating...');\n\n      if (columns.includes('light_power')) {\n        await sql`ALTER TABLE readings RENAME COLUMN light_power TO light_status;`;\n        await sql`ALTER TABLE readings ALTER COLUMN light_status TYPE BOOLEAN USING (light_status > 0);`;\n        console.log('[DB MIGRATE] Renamed light_power -> light_status');\n      }\n\n      if (columns.includes('heater_power')) {\n        await sql`ALTER TABLE readings RENAME COLUMN heater_power TO heater_status;`;\n        await sql`ALTER TABLE readings ALTER COLUMN heater_status TYPE BOOLEAN USING (heater_status > 0);`;\n        console.log('[DB MIGRATE] Renamed heater_power -> heater_status');\n      }\n\n      if (!columns.includes('light_status')) {\n        await sql`ALTER TABLE readings ADD COLUMN light_status BOOLEAN DEFAULT false;`;\n        console.log('[DB MIGRATE] Added light_status column');\n      }\n\n      if (!columns.includes('heater_status')) {\n        await sql`ALTER TABLE readings ADD COLUMN heater_status BOOLEAN DEFAULT false;`;\n        console.log('[DB MIGRATE] Added heater_status column');\n      }\n\n      return NextResponse.json({\n        success: true,\n        message: 'Migration completed',\n        before: columnsCheck.rows,\n        after: 'Check /api/debug for new structure'\n      });\n    }\n\n    if (hasNewStructure) {\n      console.log('[DB MIGRATE] Schema is already up to date');\n      return NextResponse.json({\n        success: true,\n        message: 'Schema already correct',\n        columns: columnsCheck.rows\n      });\n    }\n\n    console.log('[DB MIGRATE] Table does not exist or is broken, recreating...');\n\n    await sql`DROP TABLE IF EXISTS readings CASCADE;`;\n\n    await sql`CREATE TABLE readings (\n      id SERIAL PRIMARY KEY,\n      timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n      temperature NUMERIC(5,2),\n      humidity NUMERIC(5,2),\n      light_status BOOLEAN DEFAULT false,\n      heater_status BOOLEAN DEFAULT false\n    );`;\n\n    console.log('[DB MIGRATE] Table recreated from scratch');\n\n    return NextResponse.json({\n      success: true,\n      message: 'Table recreated',\n      action: 'dropped_and_recreated'\n    });\n  } catch (error) {\n    console.error('[DB MIGRATE ERROR]:', error);\n    return NextResponse.json(\n      {\n        error: error.toString(),\n        stack: error.stack\n      },\n      { status: 500 }\n    );\n  }\n}\n",
      "content_hash": "2f68dd94a09044178d0c02b467f65104",
      "lines": 96
    },
    "components/ThresholdScale.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/ThresholdScale.jsx",
      "relative_path": "components/ThresholdScale.jsx",
      "size": 1032,
      "extension": ".jsx",
      "is_code": true,
      "content": "export default function ThresholdScale({ value, min, max, thresholds, type }) {\n  const position = Math.min(100, Math.max(0, ((value - min) / (max - min)) * 100));\n\n  return (\n    <div className=\"relative h-3 rounded-full overflow-hidden bg-slate-700/30\">\n      <div className=\"absolute inset-0 flex\">\n        {thresholds.map((threshold, idx) => (\n          <div\n            key={idx}\n            className={`h-full ${threshold.color}`}\n            style={{ width: threshold.width }}\n          />\n        ))}\n      </div>\n\n      <div\n        className=\"absolute top-1/2 -translate-y-1/2 transition-all duration-500 ease-out\"\n        style={{ left: `${position}%` }}\n      >\n        <div className=\"relative\">\n          <div className=\"absolute left-1/2 -translate-x-1/2 w-0.5 h-8 -top-2 bg-white shadow-lg shadow-white/50\" />\n          <div className=\"absolute left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-lg shadow-white/50 ring-2 ring-slate-900\" />\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "content_hash": "7e54062693fcf86eaae8e96808c23248",
      "lines": 28
    },
    "components/SettingsModal.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/SettingsModal.jsx",
      "relative_path": "components/SettingsModal.jsx",
      "size": 1997,
      "extension": ".jsx",
      "is_code": true,
      "content": "'use client';\n\nimport { X } from 'lucide-react';\nimport { useState } from 'react';\n\nexport default function SettingsModal({ isOpen, onClose, tabs }) {\n  const [activeTab, setActiveTab] = useState(0);\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n      <div\n        className=\"absolute inset-0 bg-black/60 backdrop-blur-sm\"\n        onClick={onClose}\n      />\n\n      <div className=\"relative bg-slate-800/95 backdrop-blur-md rounded-2xl shadow-2xl border border-slate-700/50 max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col\">\n        {/* Header */}\n        <div className=\"bg-slate-800/95 backdrop-blur-md border-b border-slate-700/50 p-6 flex items-center justify-between\">\n          <h2 className=\"text-2xl font-bold text-white\">Einstellungen</h2>\n          <button\n            onClick={onClose}\n            className=\"p-2 hover:bg-slate-700/50 rounded-lg transition-colors\"\n          >\n            <X className=\"w-6 h-6 text-slate-400\" />\n          </button>\n        </div>\n\n        {/* Tabs */}\n        {tabs && tabs.length > 1 && (\n          <div className=\"flex border-b border-slate-700/50 px-6\">\n            {tabs.map((tab, idx) => (\n              <button\n                key={idx}\n                onClick={() => setActiveTab(idx)}\n                className={`px-4 py-3 text-sm font-medium transition-colors relative ${\n                  activeTab === idx\n                    ? 'text-emerald-400'\n                    : 'text-slate-400 hover:text-slate-300'\n                }`}\n              >\n                {tab.label}\n                {activeTab === idx && (\n                  <div className=\"absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-400\" />\n                )}\n              </button>\n            ))}\n          </div>\n        )}\n\n        {/* Content */}\n        <div className=\"p-6 overflow-y-auto\">\n          {tabs ? tabs[activeTab].content : null}\n        </div>\n      </div>\n    </div>\n  );\n}\n",
      "content_hash": "ab6a99ee3a74bcef9a4d89a45553d687",
      "lines": 60
    },
    "components/LoginScreen.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/LoginScreen.jsx",
      "relative_path": "components/LoginScreen.jsx",
      "size": 5733,
      "extension": ".jsx",
      "is_code": true,
      "content": "'use client';\n\nimport { useState } from 'react';\nimport { Activity, Lock, Eye, EyeOff } from 'lucide-react';\nimport toast from 'react-hot-toast';\n\nexport default function LoginScreen({ onLoginSuccess }) {\n  const [password, setPassword] = useState('');\n  const [rememberMe, setRememberMe] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n\n    if (!password.trim()) {\n      toast.error('Bitte Passwort eingeben');\n      return;\n    }\n\n    setLoading(true);\n\n    try {\n      const res = await fetch('/api/auth', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ password }),\n      });\n\n      const data = await res.json();\n\n      if (res.ok && data.success) {\n        if (rememberMe) {\n          localStorage.setItem('flitzhq_auth', 'true');\n        } else {\n          sessionStorage.setItem('flitzhq_auth', 'true');\n        }\n\n        toast.success('Willkommen bei FlitzHQ! \ud83c\udf89');\n        onLoginSuccess();\n      } else {\n        toast.error(data.message || 'Falsches Passwort');\n        setPassword('');\n      }\n    } catch (error) {\n      console.error('Login Error:', error);\n      toast.error('Verbindungsfehler - bitte erneut versuchen');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-slate-950 flex items-center justify-center p-4\">\n      <div className=\"fixed inset-0 -z-10 opacity-10\">\n        <div className=\"absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900/80 to-slate-950\" />\n      </div>\n\n      <div className=\"w-full max-w-md\">\n        <div className=\"bg-slate-900/70 backdrop-blur-md rounded-2xl p-8 shadow-2xl shadow-black/20 border border-slate-700/30\">\n          <div className=\"flex flex-col items-center mb-8\">\n            <div className=\"w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30 mb-4\">\n              <Activity size={32} strokeWidth={2.5} />\n            </div>\n            <h1 className=\"font-bold text-2xl tracking-tight text-slate-100\">\n              Flitz<span className=\"text-emerald-400\">HQ</span>\n            </h1>\n            <p className=\"text-slate-500 text-sm mt-2\">Smart Home Dashboard</p>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-slate-400 text-sm font-medium block\">Passwort</label>\n              <div className=\"relative\">\n                <div className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500\">\n                  <Lock size={18} />\n                </div>\n                <input\n                  type={showPassword ? 'text' : 'password'}\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  disabled={loading}\n                  className=\"w-full bg-slate-800/60 border border-slate-700/50 rounded-xl pl-10 pr-12 py-3 text-slate-100 placeholder-slate-600 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500/50 transition-all disabled:opacity-50\"\n                  placeholder=\"Passwort eingeben\"\n                  autoFocus\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300 transition-colors\"\n                >\n                  {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\n                </button>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <input\n                type=\"checkbox\"\n                id=\"rememberMe\"\n                checked={rememberMe}\n                onChange={(e) => setRememberMe(e.target.checked)}\n                className=\"w-4 h-4 rounded border-slate-700 bg-slate-800 text-emerald-500 focus:ring-emerald-500/50 focus:ring-2 cursor-pointer\"\n              />\n              <label htmlFor=\"rememberMe\" className=\"text-slate-400 text-sm cursor-pointer select-none\">\n                Angemeldet bleiben\n              </label>\n            </div>\n\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center gap-2\">\n                  <svg\n                    className=\"animate-spin h-5 w-5\"\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                  >\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path\n                      className=\"opacity-75\"\n                      fill=\"currentColor\"\n                      d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                    ></path>\n                  </svg>\n                  Anmelden...\n                </span>\n              ) : (\n                'Anmelden'\n              )}\n            </button>\n          </form>\n        </div>\n\n        <p className=\"text-center text-slate-600 text-xs mt-6\">Secure authentication powered by Vercel</p>\n      </div>\n    </div>\n  );\n}\n",
      "content_hash": "cee39a26b80ef485d60e650a6a50ff1d",
      "lines": 144
    },
    "components/ServiceWorkerRegister.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/ServiceWorkerRegister.jsx",
      "relative_path": "components/ServiceWorkerRegister.jsx",
      "size": 394,
      "extension": ".jsx",
      "is_code": true,
      "content": "'use client';\n\nimport { useEffect } from 'react';\n\nexport default function ServiceWorkerRegister() {\n  useEffect(() => {\n    if ('serviceWorker' in navigator) {\n      navigator.serviceWorker\n        .register('/sw.js')\n        .then((reg) => console.log('[SW] Registered:', reg.scope))\n        .catch((err) => console.error('[SW] Registration failed:', err));\n    }\n  }, []);\n\n  return null;\n}\n",
      "content_hash": "bb28a9f098906447f5d3cee264f89a53",
      "lines": 17
    },
    "components/EventsModal.js": {
      "path": "/Users/marcus.braun/repos/geckohub/components/EventsModal.js",
      "relative_path": "components/EventsModal.js",
      "size": 7784,
      "extension": ".js",
      "is_code": true,
      "content": "'use client';\n\nimport React from 'react';\nimport { X, Lightbulb, Flame, Calendar } from 'lucide-react';\n\nexport default function EventsModal({ isOpen, onClose, events }) {\n  if (!isOpen) return null;\n\n  // Formatiere Datum/Zeit f\u00fcr bessere Lesbarkeit\n  const formatDateTime = (timestamp) => {\n    const date = new Date(timestamp);\n    const dateStr = date.toLocaleDateString('de-DE', {\n      day: '2-digit',\n      month: 'short'\n    });\n    const timeStr = date.toLocaleTimeString('de-DE', {\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n    return { date: dateStr, time: timeStr };\n  };\n\n  // Device Config f\u00fcr Icons und Farben\n  const deviceConfig = {\n    light: {\n      icon: Lightbulb,\n      name: 'Tageslicht',\n      colorOn: 'text-yellow-400',\n      colorOff: 'text-yellow-600',\n      bgOn: 'bg-yellow-500/10',\n      bgOff: 'bg-slate-700/30'\n    },\n    heater: {\n      icon: Flame,\n      name: 'Heizung',\n      colorOn: 'text-orange-400',\n      colorOff: 'text-orange-600',\n      bgOn: 'bg-orange-500/10',\n      bgOff: 'bg-slate-700/30'\n    }\n  };\n\n  return (\n    <>\n      {/* Overlay */}\n      <div\n        className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-40 animate-fadeIn\"\n        onClick={onClose}\n      />\n\n      {/* Modal */}\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none\">\n        <div\n          className=\"bg-slate-800/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 w-full max-w-4xl max-h-[85vh] flex flex-col pointer-events-auto animate-slideUp\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          {/* Header - Sticky */}\n          <div className=\"flex items-center justify-between p-6 border-b border-slate-700/50\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 bg-emerald-500/20 rounded-lg\">\n                <Calendar size={24} className=\"text-emerald-400\" />\n              </div>\n              <div>\n                <h2 className=\"text-xl font-bold text-slate-100\">Device Events</h2>\n                <p className=\"text-sm text-slate-400 mt-0.5\">\n                  {events.length} {events.length === 1 ? 'Event' : 'Events'}\n                </p>\n              </div>\n            </div>\n            <button\n              onClick={onClose}\n              className=\"p-2 hover:bg-white/10 rounded-lg transition-colors\"\n              aria-label=\"Schlie\u00dfen\"\n            >\n              <X size={24} className=\"text-slate-400\" />\n            </button>\n          </div>\n\n          {/* Table Container - Scrollbar */}\n          <div className=\"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800/50\">\n            {events.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center h-64 text-slate-500\">\n                <Calendar size={48} className=\"mb-3 opacity-40\" />\n                <p>Keine Events gefunden</p>\n              </div>\n            ) : (\n              <table className=\"w-full\">\n                <thead className=\"sticky top-0 bg-slate-800/95 backdrop-blur-md border-b border-slate-700/50 z-10\">\n                  <tr>\n                    <th className=\"text-left p-4 text-xs font-bold uppercase tracking-wider text-slate-400\">\n                      Zeit\n                    </th>\n                    <th className=\"text-left p-4 text-xs font-bold uppercase tracking-wider text-slate-400 hidden sm:table-cell\">\n                      Datum\n                    </th>\n                    <th className=\"text-left p-4 text-xs font-bold uppercase tracking-wider text-slate-400\">\n                      Device\n                    </th>\n                    <th className=\"text-left p-4 text-xs font-bold uppercase tracking-wider text-slate-400\">\n                      Aktion\n                    </th>\n                    <th className=\"text-left p-4 text-xs font-bold uppercase tracking-wider text-slate-400 hidden md:table-cell\">\n                      Quelle\n                    </th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {events.map((event, idx) => {\n                    const config = deviceConfig[event.device];\n                    const Icon = config?.icon || Calendar;\n                    const isOn = event.action === 'on';\n                    const { date, time } = formatDateTime(event.timestamp);\n\n                    return (\n                      <tr\n                        key={event.id || idx}\n                        className=\"border-b border-slate-700/30 hover:bg-white/5 transition-colors\"\n                      >\n                        {/* Zeit */}\n                        <td className=\"p-4\">\n                          <span className=\"font-mono text-sm text-slate-300 font-semibold\">\n                            {time}\n                          </span>\n                          {/* Mobile: Datum unter Zeit */}\n                          <span className=\"block sm:hidden text-xs text-slate-500 mt-1\">\n                            {date}\n                          </span>\n                        </td>\n\n                        {/* Datum - nur Desktop */}\n                        <td className=\"p-4 hidden sm:table-cell\">\n                          <span className=\"text-sm text-slate-400\">\n                            {date}\n                          </span>\n                        </td>\n\n                        {/* Device mit Icon */}\n                        <td className=\"p-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <div className={`p-1.5 rounded-lg ${isOn ? config?.bgOn : config?.bgOff}`}>\n                              <Icon\n                                size={18}\n                                className={isOn ? config?.colorOn : config?.colorOff}\n                              />\n                            </div>\n                            <span className=\"text-sm text-slate-200 hidden sm:inline\">\n                              {config?.name || event.device}\n                            </span>\n                          </div>\n                        </td>\n\n                        {/* Aktion */}\n                        <td className=\"p-4\">\n                          <span\n                            className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${\n                              isOn\n                                ? 'bg-emerald-500/20 text-emerald-400'\n                                : 'bg-slate-700/50 text-slate-400'\n                            }`}\n                          >\n                            {isOn ? '\u25cf AN' : '\u25cb AUS'}\n                          </span>\n                        </td>\n\n                        {/* Quelle - nur Desktop */}\n                        <td className=\"p-4 hidden md:table-cell\">\n                          <span className=\"text-xs text-slate-500 uppercase tracking-wider\">\n                            {event.source || 'user'}\n                          </span>\n                        </td>\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <style jsx>{`\n        @keyframes fadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n        @keyframes slideUp {\n          from {\n            opacity: 0;\n            transform: translateY(20px) scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n          }\n        }\n        .animate-fadeIn {\n          animation: fadeIn 0.2s ease-out;\n        }\n        .animate-slideUp {\n          animation: slideUp 0.3s ease-out;\n        }\n      `}</style>\n    </>\n  );\n}\n",
      "content_hash": "402d0a1c49c3aa471c80ea1a8235ecdf",
      "lines": 206
    },
    "components/NotificationSettings.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/NotificationSettings.jsx",
      "relative_path": "components/NotificationSettings.jsx",
      "size": 10702,
      "extension": ".jsx",
      "is_code": true,
      "content": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Bell, Save, TestTube } from 'lucide-react';\n\nexport default function NotificationSettings() {\n  const [settings, setSettings] = useState({\n    push_enabled: false,\n    temp_critical_low: 18,\n    temp_critical_high: 30,\n    humidity_critical_low: 40,\n    humidity_critical_high: 90,\n    notification_cooldown_minutes: 60\n  });\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [message, setMessage] = useState('');\n  const [pushSupported, setPushSupported] = useState(false);\n  const [pushPermission, setPushPermission] = useState('default');\n\n  useEffect(() => {\n    checkPushSupport();\n    fetchSettings();\n  }, []);\n\n  const checkPushSupport = () => {\n    if ('serviceWorker' in navigator && 'PushManager' in window) {\n      setPushSupported(true);\n      setPushPermission(Notification.permission);\n    }\n  };\n\n  const fetchSettings = async () => {\n    try {\n      const response = await fetch('/api/notification-settings');\n      const data = await response.json();\n      setSettings(data);\n    } catch (error) {\n      console.error('Error fetching settings:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const requestPushPermission = async () => {\n    if (!pushSupported) {\n      setMessage('Push Notifications nicht unterst\u00fctzt');\n      return 'denied';\n    }\n\n    try {\n      const permission = await Notification.requestPermission();\n      setPushPermission(permission);\n\n      if (permission === 'granted') {\n        await subscribeToPush();\n        setMessage('\u2713 Push Notifications aktiviert');\n        setTimeout(() => setMessage(''), 3000);\n      } else {\n        setMessage('Push Permission verweigert');\n      }\n\n      return permission;\n    } catch (error) {\n      console.error('Error requesting permission:', error);\n      setMessage('Fehler beim Aktivieren');\n      return 'denied';\n    }\n  };\n\n  const subscribeToPush = async () => {\n    try {\n      const registration = await navigator.serviceWorker.ready;\n\n      const subscription = await registration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: urlBase64ToUint8Array(process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY)\n      });\n\n      await fetch('/api/push/subscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(subscription)\n      });\n    } catch (error) {\n      console.error('Error subscribing to push:', error);\n      throw error;\n    }\n  };\n\n  const handleTogglePush = async () => {\n    if (!settings.push_enabled && pushPermission !== 'granted') {\n      const permission = await requestPushPermission();\n      if (permission !== 'granted') return;\n    }\n\n    setSettings({ ...settings, push_enabled: !settings.push_enabled });\n  };\n\n  const handleSave = async () => {\n    setSaving(true);\n    setMessage('');\n\n    try {\n      const response = await fetch('/api/notification-settings', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(settings)\n      });\n\n      if (response.ok) {\n        setMessage('\u2713 Gespeichert');\n        setTimeout(() => setMessage(''), 3000);\n      } else {\n        setMessage('Fehler beim Speichern');\n      }\n    } catch (error) {\n      console.error('Error saving settings:', error);\n      setMessage('Fehler beim Speichern');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const sendTestNotification = async () => {\n    if (pushPermission !== 'granted') {\n      setMessage('Bitte zuerst Push aktivieren');\n      return;\n    }\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      registration.showNotification('\ud83e\udd8e FlitzHQ Test', {\n        body: 'Push Notifications funktionieren!',\n        icon: '/icon-192.png',\n        badge: '/icon-192.png'\n      });\n      setMessage('\u2713 Test-Notification gesendet');\n      setTimeout(() => setMessage(''), 3000);\n    } catch (error) {\n      console.error('Error sending test:', error);\n      setMessage('Fehler beim Test');\n    }\n  };\n\n  if (loading) {\n    return <div className=\"animate-pulse\">L\u00e4dt...</div>;\n  }\n\n  return (\n    <div>\n      <div className=\"flex items-center justify-between mb-6\">\n        <div className=\"flex items-center gap-3\">\n          <Bell className=\"w-6 h-6 text-emerald-400\" />\n          <h3 className=\"text-xl font-semibold text-white\">Benachrichtigungen</h3>\n        </div>\n      </div>\n\n      {/* Push Notifications */}\n      <div className=\"mb-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div>\n            <h4 className=\"text-white font-medium\">Push Notifications</h4>\n            <p className=\"text-sm text-slate-400\">\n              {pushPermission === 'granted' ? 'Aktiviert' :\n               pushPermission === 'denied' ? 'Blockiert in Browser-Einstellungen' :\n               'Noch nicht aktiviert'}\n            </p>\n          </div>\n          <button\n            onClick={handleTogglePush}\n            disabled={!pushSupported || pushPermission === 'denied'}\n            className={`relative inline-flex h-8 w-14 items-center rounded-full transition-colors ${\n              settings.push_enabled ? 'bg-emerald-500' : 'bg-slate-600'\n            } disabled:opacity-50`}\n          >\n            <span\n              className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${\n                settings.push_enabled ? 'translate-x-7' : 'translate-x-1'\n              }`}\n            />\n          </button>\n        </div>\n\n        {pushPermission === 'granted' && (\n          <button\n            onClick={sendTestNotification}\n            className=\"text-sm text-emerald-400 hover:text-emerald-300 flex items-center gap-2\"\n          >\n            <TestTube className=\"w-4 h-4\" />\n            Test-Benachrichtigung senden\n          </button>\n        )}\n      </div>\n\n      {/* Schwellwerte */}\n      <div className=\"space-y-4 mb-6\">\n        <h4 className=\"text-white font-medium\">Kritische Schwellwerte</h4>\n\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div>\n            <label className=\"block text-sm text-slate-400 mb-2\">\n              Min. Temperatur (\u00b0C)\n            </label>\n            <input\n              type=\"number\"\n              value={settings.temp_critical_low}\n              onChange={(e) => setSettings({ ...settings, temp_critical_low: parseFloat(e.target.value) })}\n              className=\"w-full bg-slate-700/50 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 outline-none\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm text-slate-400 mb-2\">\n              Max. Temperatur (\u00b0C)\n            </label>\n            <input\n              type=\"number\"\n              value={settings.temp_critical_high}\n              onChange={(e) => setSettings({ ...settings, temp_critical_high: parseFloat(e.target.value) })}\n              className=\"w-full bg-slate-700/50 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 outline-none\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm text-slate-400 mb-2\">\n              Min. Luftfeuchtigkeit (%)\n            </label>\n            <input\n              type=\"number\"\n              value={settings.humidity_critical_low}\n              onChange={(e) => setSettings({ ...settings, humidity_critical_low: parseFloat(e.target.value) })}\n              className=\"w-full bg-slate-700/50 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 outline-none\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm text-slate-400 mb-2\">\n              Max. Luftfeuchtigkeit (%)\n            </label>\n            <input\n              type=\"number\"\n              value={settings.humidity_critical_high}\n              onChange={(e) => setSettings({ ...settings, humidity_critical_high: parseFloat(e.target.value) })}\n              className=\"w-full bg-slate-700/50 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 outline-none\"\n            />\n          </div>\n        </div>\n      </div>\n\n      {/* Cooldown */}\n      <div className=\"mb-6\">\n        <label className=\"block text-sm text-slate-400 mb-2\">\n          Benachrichtigungs-Pause (Minuten)\n        </label>\n        <input\n          type=\"number\"\n          value={settings.notification_cooldown_minutes}\n          onChange={(e) => setSettings({ ...settings, notification_cooldown_minutes: parseInt(e.target.value) })}\n          className=\"w-full bg-slate-700/50 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 outline-none\"\n        />\n        <p className=\"text-xs text-slate-500 mt-1\">\n          Zeit zwischen Benachrichtigungen f\u00fcr das gleiche Problem\n        </p>\n      </div>\n\n      {/* Info */}\n      <div className=\"bg-slate-700/30 rounded-lg p-4 mb-4 text-sm text-slate-300\">\n        <p>Push Notifications funktionieren nur wenn die App installiert ist (Android).</p>\n        <p className=\"mt-1\">\n          Du wirst benachrichtigt wenn Werte au\u00dferhalb der kritischen Bereiche liegen.\n        </p>\n      </div>\n\n      {/* Save Button */}\n      <button\n        onClick={handleSave}\n        disabled={saving}\n        className=\"w-full bg-emerald-500 hover:bg-emerald-600 disabled:bg-slate-600 text-white font-semibold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n      >\n        {saving ? (\n          <>\n            <div className=\"w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin\" />\n            Speichert...\n          </>\n        ) : (\n          <>\n            <Save className=\"w-5 h-5\" />\n            Speichern\n          </>\n        )}\n      </button>\n\n      {message && (\n        <div className={`mt-4 text-center text-sm ${\n          message.includes('\u2713') ? 'text-emerald-400' : 'text-red-400'\n        }`}>\n          {message}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction urlBase64ToUint8Array(base64String) {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4);\n  const base64 = (base64String + padding)\n    .replace(/\\-/g, '+')\n    .replace(/_/g, '/');\n  const rawData = window.atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  return outputArray;\n}\n",
      "content_hash": "d69f37f08f83b4d30aa4fdb647cb3e8d",
      "lines": 317
    },
    "components/InstallPrompt.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/InstallPrompt.jsx",
      "relative_path": "components/InstallPrompt.jsx",
      "size": 1204,
      "extension": ".jsx",
      "is_code": true,
      "content": "'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Download } from 'lucide-react';\n\nexport default function InstallPrompt() {\n  const [deferredPrompt, setDeferredPrompt] = useState(null);\n  const [showInstall, setShowInstall] = useState(false);\n\n  useEffect(() => {\n    const handler = (e) => {\n      e.preventDefault();\n      setDeferredPrompt(e);\n      setShowInstall(true);\n    };\n\n    window.addEventListener('beforeinstallprompt', handler);\n\n    return () => window.removeEventListener('beforeinstallprompt', handler);\n  }, []);\n\n  const handleInstall = async () => {\n    if (!deferredPrompt) return;\n\n    deferredPrompt.prompt();\n    const { outcome } = await deferredPrompt.userChoice;\n\n    if (outcome === 'accepted') {\n      setDeferredPrompt(null);\n      setShowInstall(false);\n    }\n  };\n\n  if (!showInstall) return null;\n\n  return (\n    <button\n      onClick={handleInstall}\n      className=\"fixed bottom-4 right-4 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-xl shadow-lg shadow-emerald-500/30 flex items-center gap-2 transition-all z-50\"\n    >\n      <Download size={20} />\n      <span className=\"font-bold\">App installieren</span>\n    </button>\n  );\n}\n",
      "content_hash": "6698762c9aa439aa1eebeacc1fd35f0b",
      "lines": 46
    },
    "components/LightScheduleSettings.jsx": {
      "path": "/Users/marcus.braun/repos/geckohub/components/LightScheduleSettings.jsx",
      "relative_path": "components/LightScheduleSettings.jsx",
      "size": 4990,
      "extension": ".jsx",
      "is_code": true,
      "content": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Clock, Save } from 'lucide-react';\n\nexport default function LightScheduleSettings() {\n  const [schedule, setSchedule] = useState({\n    enabled: false,\n    time_on: '08:00',\n    time_off: '20:00'\n  });\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [message, setMessage] = useState('');\n\n  useEffect(() => {\n    fetchSchedule();\n  }, []);\n\n  const fetchSchedule = async () => {\n    try {\n      const response = await fetch('/api/light-schedule');\n      const data = await response.json();\n      setSchedule(data);\n    } catch (error) {\n      console.error('Error fetching schedule:', error);\n      setMessage('Fehler beim Laden');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSave = async () => {\n    setSaving(true);\n    setMessage('');\n\n    try {\n      const response = await fetch('/api/light-schedule', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(schedule)\n      });\n\n      if (response.ok) {\n        setMessage('\u2713 Gespeichert');\n        setTimeout(() => setMessage(''), 3000);\n      } else {\n        setMessage('Fehler beim Speichern');\n      }\n    } catch (error) {\n      console.error('Error saving schedule:', error);\n      setMessage('Fehler beim Speichern');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"animate-pulse\">\n        <div className=\"h-8 bg-slate-700/30 rounded mb-4 w-48\"></div>\n        <div className=\"h-12 bg-slate-700/30 rounded mb-4\"></div>\n        <div className=\"h-12 bg-slate-700/30 rounded\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div>\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-6\">\n        <div className=\"flex items-center gap-3\">\n          <Clock className=\"w-6 h-6 text-yellow-400\" />\n          <h3 className=\"text-xl font-semibold text-white\">Zeitplan Tageslicht</h3>\n        </div>\n\n        {/* Enable/Disable Toggle */}\n        <button\n          onClick={() => setSchedule({ ...schedule, enabled: !schedule.enabled })}\n          className={`relative inline-flex h-8 w-14 items-center rounded-full transition-colors ${\n            schedule.enabled ? 'bg-emerald-500' : 'bg-slate-600'\n          }`}\n        >\n          <span\n            className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${\n              schedule.enabled ? 'translate-x-7' : 'translate-x-1'\n            }`}\n          />\n        </button>\n      </div>\n\n      {/* Zeit-Inputs */}\n      <div className=\"space-y-4 mb-6\">\n        <div>\n          <label className=\"block text-sm text-slate-400 mb-2\">\n            Einschalten (Morgens)\n          </label>\n          <input\n            type=\"time\"\n            value={schedule.time_on}\n            onChange={(e) => setSchedule({ ...schedule, time_on: e.target.value })}\n            className=\"w-full bg-slate-700/50 text-white px-4 py-3 rounded-lg border border-slate-600 focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 outline-none transition-all\"\n          />\n        </div>\n\n        <div>\n          <label className=\"block text-sm text-slate-400 mb-2\">\n            Ausschalten (Abends)\n          </label>\n          <input\n            type=\"time\"\n            value={schedule.time_off}\n            onChange={(e) => setSchedule({ ...schedule, time_off: e.target.value })}\n            className=\"w-full bg-slate-700/50 text-white px-4 py-3 rounded-lg border border-slate-600 focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 outline-none transition-all\"\n          />\n        </div>\n      </div>\n\n      {/* Info Box */}\n      <div className=\"bg-slate-700/30 rounded-lg p-4 mb-4 text-sm text-slate-300\">\n        <p>Der Zeitplan gilt f\u00fcr alle Wochentage gleich.</p>\n        <p className=\"mt-1\">\n          Status:{' '}\n          <span className={schedule.enabled ? 'text-emerald-400' : 'text-slate-400'}>\n            {schedule.enabled ? 'Aktiv' : 'Deaktiviert'}\n          </span>\n        </p>\n      </div>\n\n      {/* Save Button */}\n      <button\n        onClick={handleSave}\n        disabled={saving}\n        className=\"w-full bg-yellow-500 hover:bg-yellow-600 disabled:bg-slate-600 text-slate-900 font-semibold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n      >\n        {saving ? (\n          <>\n            <div className=\"w-5 h-5 border-2 border-slate-900/20 border-t-slate-900 rounded-full animate-spin\" />\n            Speichert...\n          </>\n        ) : (\n          <>\n            <Save className=\"w-5 h-5\" />\n            Speichern\n          </>\n        )}\n      </button>\n\n      {/* Message */}\n      {message && (\n        <div\n          className={`mt-4 text-center text-sm ${\n            message.includes('\u2713') ? 'text-emerald-400' : 'text-red-400'\n          }`}\n        >\n          {message}\n        </div>\n      )}\n    </div>\n  );\n}\n",
      "content_hash": "dfb544b7bdcf58647b1488189aadbfb6",
      "lines": 162
    },
    "public/manifest.json": {
      "path": "/Users/marcus.braun/repos/geckohub/public/manifest.json",
      "relative_path": "public/manifest.json",
      "size": 1340,
      "extension": ".json",
      "is_code": true,
      "content": "{\n  \"name\": \"FlitzHQ - Smart Home Dashboard\",\n  \"short_name\": \"FlitzHQ\",\n  \"description\": \"Temperature, Humidity & Device Control Dashboard\",\n  \"start_url\": \"/\",\n  \"display\": \"standalone\",\n  \"background_color\": \"#0f172a\",\n  \"theme_color\": \"#10b981\",\n  \"orientation\": \"portrait\",\n  \"scope\": \"/\",\n  \"icons\": [\n    {\n      \"src\": \"/icons/android-launchericon-144-144.png\",\n      \"sizes\": \"144x144\",\n      \"type\": \"image/png\"\n    },\n    {\n      \"src\": \"/icons/android-launchericon-192-192.png\",\n      \"sizes\": \"192x192\",\n      \"type\": \"image/png\"\n    },\n    {\n      \"src\": \"/icons/android-launchericon-512-512.png\",\n      \"sizes\": \"512x512\",\n      \"type\": \"image/png\"\n    },\n    {\n      \"src\": \"/icons/android-launchericon-192-192.png\",\n      \"sizes\": \"192x192\",\n      \"type\": \"image/png\",\n      \"purpose\": \"maskable\"\n    },\n    {\n      \"src\": \"/icons/android-launchericon-512-512.png\",\n      \"sizes\": \"512x512\",\n      \"type\": \"image/png\",\n      \"purpose\": \"maskable\"\n    }\n  ],\n  \"shortcuts\": [\n    {\n      \"name\": \"Dashboard\",\n      \"short_name\": \"Dashboard\",\n      \"description\": \"Zur Startseite\",\n      \"url\": \"/\",\n      \"icons\": [\n        {\n          \"src\": \"/icons/android-launchericon-192-192.png\",\n          \"sizes\": \"192x192\"\n        }\n      ]\n    }\n  ],\n  \"categories\": [\"utilities\", \"lifestyle\"],\n  \"lang\": \"de-DE\",\n  \"dir\": \"ltr\"\n}\n",
      "content_hash": "f4165b64d94b304175966ca77527d2a2",
      "lines": 58
    },
    "public/sw.js": {
      "path": "/Users/marcus.braun/repos/geckohub/public/sw.js",
      "relative_path": "public/sw.js",
      "size": 4843,
      "extension": ".js",
      "is_code": true,
      "content": "const CACHE_NAME = 'flitzhq-v2'; // \u2190 Version erh\u00f6ht f\u00fcr sofortiges Update\nconst STATIC_CACHE = 'flitzhq-static-v2';\nconst API_CACHE = 'flitzhq-api-v2';\n\n// Static Assets die gecacht werden sollen\nconst STATIC_ASSETS = [\n  '/',\n  '/manifest.json',\n  '/icons/android-launchericon-144-144.png',\n  '/icons/android-launchericon-192-192.png',\n  '/icons/android-launchericon-512-512.png',\n  '/apple-touch-icon.png'\n];\n\n// Install Event - Cache Static Assets\nself.addEventListener('install', (event) => {\n  console.log('[SW v2] Installing...');\n  \n  event.waitUntil(\n    caches.open(STATIC_CACHE)\n      .then((cache) => {\n        console.log('[SW v2] Caching static assets');\n        return cache.addAll(STATIC_ASSETS);\n      })\n      .then(() => self.skipWaiting()) // Sofort aktivieren\n  );\n});\n\n// Activate Event - Cleanup alte Caches\nself.addEventListener('activate', (event) => {\n  console.log('[SW v2] Activating...');\n  \n  event.waitUntil(\n    caches.keys()\n      .then((cacheNames) => {\n        return Promise.all(\n          cacheNames.map((cacheName) => {\n            // L\u00f6sche alle Caches au\u00dfer den aktuellen\n            if (cacheName !== STATIC_CACHE && cacheName !== API_CACHE) {\n              console.log('[SW v2] Deleting old cache:', cacheName);\n              return caches.delete(cacheName);\n            }\n          })\n        );\n      })\n      .then(() => self.clients.claim()) // \u00dcbernimm sofort alle Clients\n  );\n});\n\n// Fetch Event - Unterschiedliche Strategien je nach Request-Typ\nself.addEventListener('fetch', (event) => {\n  const { request } = event;\n  const url = new URL(request.url);\n  \n  // API Routes \u2192 Network-First (immer frische Daten)\n  if (url.pathname.startsWith('/api/')) {\n    event.respondWith(networkFirstStrategy(request));\n    return;\n  }\n  \n  // Static Assets \u2192 Cache-First (schnell, offline-f\u00e4hig)\n  event.respondWith(cacheFirstStrategy(request));\n});\n\n// Network-First Strategie f\u00fcr API Calls\nasync function networkFirstStrategy(request) {\n  try {\n    // Versuche IMMER zuerst das Netzwerk\n    const networkResponse = await fetch(request);\n    \n    // Bei Erfolg: Cache die Response UND gib sie zur\u00fcck\n    if (networkResponse && networkResponse.status === 200) {\n      const cache = await caches.open(API_CACHE);\n      cache.put(request, networkResponse.clone());\n      \n      console.log('[SW v2] Network success:', request.url);\n      return networkResponse;\n    }\n    \n    return networkResponse;\n    \n  } catch (error) {\n    // Netzwerk-Fehler (Offline) \u2192 Fallback zu Cache\n    console.log('[SW v2] Network failed, trying cache:', request.url);\n    \n    const cachedResponse = await caches.match(request);\n    \n    if (cachedResponse) {\n      console.log('[SW v2] Cache hit (offline fallback):', request.url);\n      return cachedResponse;\n    }\n    \n    // Kein Cache vorhanden \u2192 Fehler\n    console.error('[SW v2] No cache available:', request.url);\n    return new Response(\n      JSON.stringify({ \n        error: 'Offline und keine gecachten Daten verf\u00fcgbar',\n        offline: true \n      }),\n      { \n        status: 503,\n        headers: { 'Content-Type': 'application/json' }\n      }\n    );\n  }\n}\n\n// Cache-First Strategie f\u00fcr Static Assets\nasync function cacheFirstStrategy(request) {\n  // Suche zuerst im Cache\n  const cachedResponse = await caches.match(request);\n  \n  if (cachedResponse) {\n    console.log('[SW v2] Cache hit (static):', request.url);\n    return cachedResponse;\n  }\n  \n  // Cache Miss \u2192 Fetch aus Netzwerk\n  try {\n    const networkResponse = await fetch(request);\n    \n    // Bei Erfolg: Cache f\u00fcr zuk\u00fcnftige Requests\n    if (networkResponse && networkResponse.status === 200 && networkResponse.type === 'basic') {\n      const cache = await caches.open(STATIC_CACHE);\n      cache.put(request, networkResponse.clone());\n    }\n    \n    return networkResponse;\n    \n  } catch (error) {\n    // Offline und kein Cache \u2192 Fallback zur Root\n    if (request.destination === 'document') {\n      const rootCache = await caches.match('/');\n      if (rootCache) return rootCache;\n    }\n    \n    throw error;\n  }\n}\n\n// Push Notification Handler\nself.addEventListener('push', function(event) {\n  const data = event.data ? event.data.json() : {};\n\n  const options = {\n    body: data.body || 'FlitzHQ Notification',\n    icon: data.icon || '/icon-192.png',\n    badge: data.badge || '/icon-192.png',\n    tag: data.tag || 'flitzhq-notification',\n    requireInteraction: data.requireInteraction || false,\n    data: data.data || {}\n  };\n\n  event.waitUntil(\n    self.registration.showNotification(data.title || 'FlitzHQ', options)\n  );\n});\n\n// Notification Click Handler\nself.addEventListener('notificationclick', function(event) {\n  event.notification.close();\n\n  event.waitUntil(\n    clients.openWindow(event.notification.data.url || 'https://flitzhq.vercel.app')\n  );\n});\n",
      "content_hash": "357357799167772414f4afb626a19265",
      "lines": 167
    },
    "public/icons/icons.json": {
      "path": "/Users/marcus.braun/repos/geckohub/public/icons/icons.json",
      "relative_path": "public/icons/icons.json",
      "size": 1,
      "extension": ".json",
      "is_code": true,
      "content": "\n",
      "content_hash": "68b329da9893e34099c7d8ad5cb9c940",
      "lines": 2
    },
    "lib/pushService.js": {
      "path": "/Users/marcus.braun/repos/geckohub/lib/pushService.js",
      "relative_path": "lib/pushService.js",
      "size": 2661,
      "extension": ".js",
      "is_code": true,
      "content": "const webPush = require('web-push');\nimport { sql } from '@vercel/postgres';\n\n// VAPID Setup\nif (process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY && process.env.VAPID_PRIVATE_KEY) {\n  webPush.setVapidDetails(\n    'mailto:marcus.braun@example.com',\n    process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY,\n    process.env.VAPID_PRIVATE_KEY\n  );\n}\n\nexport async function sendCriticalAlert(type, value, threshold) {\n  try {\n    // Check if VAPID keys are set\n    if (!process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY || !process.env.VAPID_PRIVATE_KEY) {\n      console.log('Push notifications not configured - skipping');\n      return;\n    }\n\n    const result = await sql`SELECT * FROM push_subscriptions`;\n\n    if (result.rows.length === 0) {\n      console.log('No push subscriptions found');\n      return;\n    }\n\n    const notification = {\n      title: getAlertTitle(type, value),\n      body: getAlertBody(type, value, threshold),\n      icon: '/icon-192.png',\n      badge: '/icon-192.png',\n      tag: `critical-${type}`,\n      requireInteraction: true,\n      data: {\n        url: 'https://flitzhq.vercel.app',\n        type: type,\n        value: value\n      }\n    };\n\n    const promises = result.rows.map(sub => {\n      const pushSubscription = {\n        endpoint: sub.endpoint,\n        keys: sub.keys\n      };\n\n      return webPush\n        .sendNotification(pushSubscription, JSON.stringify(notification))\n        .catch(error => {\n          console.error('Push send error:', error);\n\n          if (error.statusCode === 410 || error.statusCode === 404) {\n            sql`DELETE FROM push_subscriptions WHERE endpoint = ${sub.endpoint}`;\n          }\n        });\n    });\n\n    await Promise.all(promises);\n    console.log(`Sent ${promises.length} push notifications for ${type}`);\n\n  } catch (error) {\n    console.error('Error sending push notifications:', error);\n  }\n}\n\nfunction getAlertTitle(type, value) {\n  switch(type) {\n    case 'temp_low': return `\u2744\ufe0f Temperatur zu niedrig!`;\n    case 'temp_high': return `\ud83d\udd25 Temperatur zu hoch!`;\n    case 'humidity_low': return `\ud83d\udca7 Luftfeuchtigkeit zu niedrig!`;\n    case 'humidity_high': return `\ud83d\udca7 Luftfeuchtigkeit zu hoch!`;\n    default: return '\u26a0\ufe0f FlitzHQ Alert';\n  }\n}\n\nfunction getAlertBody(type, value, threshold) {\n  switch(type) {\n    case 'temp_low': return `${value}\u00b0C (unter ${threshold}\u00b0C) - Gecko k\u00f6nnte frieren`;\n    case 'temp_high': return `${value}\u00b0C (\u00fcber ${threshold}\u00b0C) - Kritisch hei\u00df`;\n    case 'humidity_low': return `${value}% (unter ${threshold}%) - H\u00e4utungsprobleme m\u00f6glich`;\n    case 'humidity_high': return `${value}% (\u00fcber ${threshold}%) - Zu feucht`;\n    default: return `Wert: ${value}`;\n  }\n}\n",
      "content_hash": "95871cb2ef42515ba1800fcd31f5854a",
      "lines": 86
    },
    "lib/shellyStatus.js": {
      "path": "/Users/marcus.braun/repos/geckohub/lib/shellyStatus.js",
      "relative_path": "lib/shellyStatus.js",
      "size": 4782,
      "extension": ".js",
      "is_code": true,
      "content": "const SHELLY_CACHE_DURATION_MS = 10_000;\nconst STALE_THRESHOLD_MS = 5 * 60 * 1000;\nconst REQUEST_DELAY_MS = 1200;\n\nconst statusCache = {\n  data: null,\n  timestamp: 0\n};\n\nconst devices = [\n  { id: process.env.SHELLY_LIGHT_ID, type: 'light', name: 'Tageslicht' },\n  { id: process.env.SHELLY_HEATER_ID, type: 'heater', name: 'Heizung' }\n];\n\nfunction getCacheAgeSeconds(now = Date.now()) {\n  return Math.round((now - statusCache.timestamp) / 1000);\n}\n\nfunction updateCache(payload) {\n  statusCache.data = payload;\n  statusCache.timestamp = Date.now();\n}\n\nfunction parseShellyStatus(apiResponse, deviceType) {\n  const deviceStatus = apiResponse.data?.device_status;\n\n  if (!deviceStatus) {\n    throw new Error('Keine device_status in Response');\n  }\n\n  const switchData = deviceStatus['switch:0'];\n\n  if (!switchData) {\n    throw new Error(`Kein switch:0 gefunden f\u00fcr ${deviceType}`);\n  }\n\n  return {\n    output: switchData.output === true,\n    power: switchData.apower || 0,\n    voltage: switchData.voltage || 0,\n    current: switchData.current || 0,\n    energy: switchData.aenergy?.total || 0,\n    temp: switchData.temperature?.tC || null,\n    online: apiResponse.data?.online || false\n  };\n}\n\nasync function fetchDeviceStatus(device, authKey, server) {\n  if (!device.id) {\n    throw new Error(`Shelly ID f\u00fcr ${device.name} fehlt`);\n  }\n\n  const params = new URLSearchParams({\n    id: device.id,\n    auth_key: authKey\n  });\n\n  const res = await fetch(`${server}/device/status`, {\n    method: 'POST',\n    body: params,\n    signal: AbortSignal.timeout(10_000),\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded'\n    }\n  });\n\n  if (!res.ok) {\n    if (res.status === 429) {\n      throw new Error('Rate limited');\n    }\n    throw new Error(`HTTP ${res.status}`);\n  }\n\n  const data = await res.json();\n\n  if (!data.isok) {\n    throw new Error(data.errors?.[0] || 'Shelly API returned isok:false');\n  }\n\n  return parseShellyStatus(data, device.name);\n}\n\nexport async function getShellyStatus({ forceRefresh = false } = {}) {\n  const authKey = process.env.SHELLY_CLOUD_KEY;\n  const server = process.env.SHELLY_SERVER;\n  const now = Date.now();\n\n  if (!authKey || !server) {\n    const error = new Error('Shelly Konfiguration fehlt');\n    error.statusCode = 500;\n    throw error;\n  }\n\n  const cacheAgeMs = now - statusCache.timestamp;\n  const hasWarmCache = statusCache.data && cacheAgeMs < SHELLY_CACHE_DURATION_MS;\n\n  if (!forceRefresh && hasWarmCache) {\n    return {\n      ...statusCache.data,\n      cached: true,\n      cacheAge: getCacheAgeSeconds(now)\n    };\n  }\n\n  const status = {};\n  const meta = {};\n  let cacheUsed = false;\n\n  for (let i = 0; i < devices.length; i++) {\n    const device = devices[i];\n\n    try {\n      const liveStatus = await fetchDeviceStatus(device, authKey, server);\n\n      status[device.type] = liveStatus.output;\n      meta[device.type] = {\n        verified: true,\n        source: 'live',\n        age: 0\n      };\n    } catch (error) {\n      const cachedValue = statusCache.data?.status?.[device.type];\n      const cachedMeta = statusCache.data?.meta?.[device.type];\n      const cacheAgeSeconds = getCacheAgeSeconds(now);\n\n      if (\n        cachedValue !== undefined &&\n        statusCache.timestamp &&\n        now - statusCache.timestamp < STALE_THRESHOLD_MS\n      ) {\n        status[device.type] = cachedValue;\n        meta[device.type] = {\n          verified: cachedMeta?.verified ?? false,\n          source: 'cache',\n          age: cacheAgeSeconds,\n          error: error.message\n        };\n        cacheUsed = true;\n      } else {\n        status[device.type] = null;\n        meta[device.type] = {\n          verified: false,\n          source: 'error',\n          age: null,\n          error: error.message\n        };\n      }\n    }\n\n    if (i < devices.length - 1) {\n      await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY_MS));\n    }\n  }\n\n  const allVerified = devices.every((device) => meta[device.type]?.verified);\n  const anyVerified = devices.some((device) => meta[device.type]?.verified);\n\n  if (!anyVerified && !cacheUsed) {\n    const error = new Error('Shelly Status nicht verf\u00fcgbar');\n    error.statusCode = 503;\n    throw error;\n  }\n\n  const payload = {\n    success: true,\n    status,\n    meta,\n    allVerified,\n    cached: cacheUsed,\n    cacheAge: cacheUsed ? getCacheAgeSeconds(now) : 0,\n    timestamp: new Date().toISOString()\n  };\n\n  if (allVerified) {\n    updateCache({ ...payload, cached: false, cacheAge: 0 });\n  }\n\n  return payload;\n}\n\nexport function invalidateShellyCache() {\n  statusCache.timestamp = 0;\n}\n\nexport async function refreshShellyCache() {\n  try {\n    await getShellyStatus({ forceRefresh: true });\n  } catch (error) {\n    console.warn('[SHELLY CACHE REFRESH FAILED]', error.message);\n  }\n}\n",
      "content_hash": "0ae7f5588977be703b008d6bd227940e",
      "lines": 192
    },
    "lib/gecko-thresholds.js": {
      "path": "/Users/marcus.braun/repos/geckohub/lib/gecko-thresholds.js",
      "relative_path": "lib/gecko-thresholds.js",
      "size": 4750,
      "extension": ".js",
      "is_code": true,
      "content": "/**\n * Bewertet Temperatur basierend auf Kronengecko-Anforderungen\n * @param {number} temp - Temperatur in \u00b0C\n * @returns {object} { status: 'optimal'|'normal'|'critical', label: string, color: string }\n */\nexport function evaluateTemperature(temp) {\n  if (temp < 18) {\n    return {\n      status: 'critical',\n      label: 'ZU KALT',\n      color: '#60a5fa',\n      bgColor: 'bg-blue-500/20',\n      textColor: 'text-blue-400',\n      icon: '\u2744\ufe0f'\n    };\n  }\n\n  if (temp >= 18 && temp < 20) {\n    return {\n      status: 'normal',\n      label: 'K\u00fchl',\n      color: '#38bdf8',\n      bgColor: 'bg-sky-500/20',\n      textColor: 'text-sky-400',\n      icon: '\ud83c\udf21\ufe0f'\n    };\n  }\n\n  if (temp >= 20 && temp < 22) {\n    return {\n      status: 'normal',\n      label: 'Leicht k\u00fchl',\n      color: '#34d399',\n      bgColor: 'bg-emerald-500/20',\n      textColor: 'text-emerald-400',\n      icon: '\u2713'\n    };\n  }\n\n  if (temp >= 22 && temp <= 26) {\n    return {\n      status: 'optimal',\n      label: 'OPTIMAL',\n      color: '#10b981',\n      bgColor: 'bg-emerald-500/20',\n      textColor: 'text-emerald-500',\n      icon: '\u2713'\n    };\n  }\n\n  if (temp > 26 && temp <= 28) {\n    return {\n      status: 'normal',\n      label: 'Leicht warm',\n      color: '#fbbf24',\n      bgColor: 'bg-amber-500/20',\n      textColor: 'text-amber-400',\n      icon: '\u26a0\ufe0f'\n    };\n  }\n\n  if (temp > 28 && temp < 30) {\n    return {\n      status: 'normal',\n      label: 'Warm',\n      color: '#fb923c',\n      bgColor: 'bg-orange-500/20',\n      textColor: 'text-orange-400',\n      icon: '\u26a0\ufe0f'\n    };\n  }\n\n  if (temp >= 30) {\n    return {\n      status: 'critical',\n      label: 'ZU HEISS',\n      color: '#ef4444',\n      bgColor: 'bg-red-500/20',\n      textColor: 'text-red-500',\n      icon: '\ud83d\udd25'\n    };\n  }\n\n  return {\n    status: 'normal',\n    label: 'Unbekannt',\n    color: '#94a3b8',\n    bgColor: 'bg-slate-500/20',\n    textColor: 'text-slate-400',\n    icon: '\u2026'\n  };\n}\n\n/**\n * Bewertet Luftfeuchtigkeit basierend auf Kronengecko-Anforderungen\n * @param {number} humidity - Luftfeuchtigkeit in %\n * @returns {object} { status: 'optimal'|'normal'|'critical', label: string, color: string }\n */\nexport function evaluateHumidity(humidity) {\n  if (humidity < 40) {\n    return {\n      status: 'critical',\n      label: 'ZU TROCKEN',\n      color: '#ef4444',\n      bgColor: 'bg-red-500/20',\n      textColor: 'text-red-500',\n      icon: '\u26a0\ufe0f'\n    };\n  }\n\n  if (humidity >= 40 && humidity < 50) {\n    return {\n      status: 'normal',\n      label: 'Trocken',\n      color: '#fb923c',\n      bgColor: 'bg-orange-500/20',\n      textColor: 'text-orange-400',\n      icon: '\ud83d\udca7'\n    };\n  }\n\n  if (humidity >= 50 && humidity < 60) {\n    return {\n      status: 'normal',\n      label: 'Leicht trocken',\n      color: '#fbbf24',\n      bgColor: 'bg-amber-500/20',\n      textColor: 'text-amber-400',\n      icon: '\ud83d\udca7'\n    };\n  }\n\n  if (humidity >= 60 && humidity <= 80) {\n    return {\n      status: 'optimal',\n      label: 'OPTIMAL',\n      color: '#10b981',\n      bgColor: 'bg-emerald-500/20',\n      textColor: 'text-emerald-500',\n      icon: '\u2713'\n    };\n  }\n\n  if (humidity > 80 && humidity <= 85) {\n    return {\n      status: 'normal',\n      label: 'Leicht feucht',\n      color: '#34d399',\n      bgColor: 'bg-emerald-500/20',\n      textColor: 'text-emerald-400',\n      icon: '\ud83d\udca7'\n    };\n  }\n\n  if (humidity > 85 && humidity < 90) {\n    return {\n      status: 'normal',\n      label: 'Feucht',\n      color: '#60a5fa',\n      bgColor: 'bg-blue-500/20',\n      textColor: 'text-blue-400',\n      icon: '\ud83d\udca7'\n    };\n  }\n\n  if (humidity >= 90) {\n    return {\n      status: 'critical',\n      label: 'ZU FEUCHT',\n      color: '#60a5fa',\n      bgColor: 'bg-blue-500/20',\n      textColor: 'text-blue-400',\n      icon: '\ud83c\udf0a'\n    };\n  }\n\n  return {\n    status: 'normal',\n    label: 'Unbekannt',\n    color: '#94a3b8',\n    bgColor: 'bg-slate-500/20',\n    textColor: 'text-slate-400',\n    icon: '\u2026'\n  };\n}\n\nexport const TEMP_SCALE_CONFIG = {\n  min: 15,\n  max: 35,\n  thresholds: [\n    { width: '15%', color: 'bg-blue-500' },\n    { width: '10%', color: 'bg-sky-400' },\n    { width: '10%', color: 'bg-emerald-400' },\n    { width: '20%', color: 'bg-emerald-500' },\n    { width: '10%', color: 'bg-amber-400' },\n    { width: '10%', color: 'bg-orange-400' },\n    { width: '25%', color: 'bg-red-500' }\n  ]\n};\n\nexport const HUMIDITY_SCALE_CONFIG = {\n  min: 30,\n  max: 100,\n  thresholds: [\n    { width: '14.3%', color: 'bg-red-500' },\n    { width: '14.3%', color: 'bg-orange-400' },\n    { width: '14.3%', color: 'bg-amber-400' },\n    { width: '28.6%', color: 'bg-emerald-500' },\n    { width: '7.1%', color: 'bg-emerald-400' },\n    { width: '7.1%', color: 'bg-blue-400' },\n    { width: '14.3%', color: 'bg-blue-500' }\n  ]\n};\n",
      "content_hash": "342715dd114f14b9e50bc06c9482367a",
      "lines": 214
    }
  }
}